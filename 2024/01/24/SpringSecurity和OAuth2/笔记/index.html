<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Civets | Civets</title><meta name="author" content="civets"><meta name="copyright" content="civets"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Civets"><meta name="application-name" content="Civets"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Civets"><meta property="og:url" content="http://example.com/2024/01/24/SpringSecurity%E5%92%8COAuth2/%E7%AC%94%E8%AE%B0/index.html"><meta property="og:site_name" content="Civets"><meta property="og:description" content="第一章 Spring Security快速入门官方文档： https:&amp;#x2F;&amp;#x2F;docs.spring.io&amp;#x2F;spring-security&amp;#x2F;reference&amp;#x2F;index.html 功能：  身份认证（authentication） 授权（authorization） 防御常见攻击（protection"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg"><meta property="article:author" content="civets"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg"><meta name="description" content="第一章 Spring Security快速入门官方文档： https:&amp;#x2F;&amp;#x2F;docs.spring.io&amp;#x2F;spring-security&amp;#x2F;reference&amp;#x2F;index.html 功能：  身份认证（authentication） 授权（authorization） 防御常见攻击（protection"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2024/01/24/SpringSecurity%E5%92%8COAuth2/%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: civets","link":"链接: ","source":"来源: Civets","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Civets',
  title: 'Civets',
  postAI: '',
  pageFillDescription: '第一章 Spring Security快速入门, 1、身份认证（authentication）, 1.1、创建Spring Boot项目, 1.2、创建IndexController, 1.3、创建index.html, 1.4、启动项目测试Controller, 1.5、注意事项, 1.5.1、@{x2Flogout}的作用, 1.5.2、页面样式无法加载的问题, 1.6、Spring Security默认做了什么, 2、Spring Security 的底层原理, 2.1、Filter, 2.2、DelegatingFilterProxy, 2.3、FilterChainProxy, 2.4、SecurityFilterChain, 2.5、Multiple SecurityFilterChain, 3、程序的启动和运行, 3.1、DefaultSecurityFilterChain, 3.2、SecurityProperties, 第二章 Spring Security自定义配置, 1、基于内存的用户认证, 1.1、创建自定义配置, 1.2、基于内存的用户认证流程, 2、基于数据库的数据源, 2.1、SQL, 2.2、引入依赖, 2.3、配置数据源, 2.4、实体类, 2.5、Mapper, 2.6、Service, 2.7、Controller, 3、基于数据库的用户认证, 3.1、基于数据库的用户认证流程, 3.2、定义DBUserDetailsManager, 3.3、初始化UserDetailsService, 4、SpringSecurity的默认配置, 5、添加用户功能, 5.1、Controller, 5.2、Service, 5.3、修改配置, 5.4、使用Swagger测试, 5.5、关闭csrf攻击防御, 6、密码加密算法, 6.1、密码加密方式, 6.2、PasswordEncoder, 6.3、密码加密测试, 6.4、DelegatingPasswordEncoder, 7、自定义登录页面, 7.1、创建登录Controller, 7.2、创建登录页面, 7.3、配置SecurityFilterChain, 第三章 前后端分离, 1、用户认证流程, 2、引入fastjson, 3、认证成功的响应, 3.1、成功结果处理, 3.2、SecurityFilterChain配置, 4、认证失败响应, 4.1、失败结果处理, 4.2SecurityFilterChain配置, 5、注销响应, 5.1、注销结果处理, 5.2、SecurityFilterChain配置, 6、请求未认证的接口, 6.1、实现AuthenticationEntryPoint接口, 6.2、SecurityFilterChain配置, 7、跨域, 第四章 身份认证, 1、用户认证信息, 1.1、基本概念, 1.2、在Controller中获取用户信息, 2、会话并发处理, 2.1、实现处理器接口, 2.2、SecurityFilterChain配置, 第五章 授权, 1、基于request的授权, 1.1、用户-权限-资源, 配置权限, 授予权限, 请求未授权的接口, 1.2、用户-角色-资源, 配置角色, 授予角色, 1.3、用户-角色-权限-资源, 遇到的问题, 2、基于方法的授权, 2.1、开启方法授权, 2.2、给用户授予角色和权限, 2.2、常用授权注解, 第六章 OAuth2, 1、OAuth2简介, 1.1、OAuth2是什么, 1.2、OAuth2的角色, 1.3、OAuth2的使用场景, 开放系统间授权, 社交登录, 开放API, 现代微服务安全, 单块应用安全, 微服务安全, 企业内部应用认证授权, 1.4、OAuth2的四种授权模式, 第一种方式：授权码, 第二种方式：隐藏式, 第三种方式：密码式, 第四种方式：凭证式, 1.5、授权类型的选择, 2、Spring中的OAuth2, 2.1、相关角色, 2.2、Spring中的实现, 2.3、相关依赖, 2.4、授权登录的实现思路, 3、GiuHub社交登录案例, 3.1、创建应用, 3.2、创建测试项目, 3.3、配置OAuth客户端属性, 3.4、创建Controller, 3.5、创建html页面, 3.6、启动应用程序, 4、案例分析, 4.1、登录流程, 4.2、CommonOAuth2Provider第一章快速入门官方文档功能身份认证授权防御常见攻击身份认证身份认证是验证谁正在访问系统资源判断用户是否为合法用户认证用户的常见方式是要求用户输入用户名和密码授权用户进行身份认证后系统会控制谁能访问哪些资源这个过程叫做授权用户无法访问没有权限的资源防御常见攻击身份认证官方代码示例创建项目项目名依赖了创建创建在路径中创建通过使用将自动处理生成正确的以适应当前的上下文路径这样无论应用程序部署在哪个上下文路径下生成的都能正确地指向注销功能启动项目测试浏览器中访问浏览器自动跳转到登录页面输入用户名输入密码在控制台的启动日志中查找初始的默认密码点击进行登录浏览器就跳转到了页面注意事项的作用通过使用将自动处理生成正确的以适应当前的上下文路径这样无论应用程序部署在哪个上下文路径下生成的都能正确地指向注销功能例如如果我们在配置文件中添加如下内容那么可以自动处理为正确的相对路径但是如果是普通的路径就会不正确页面样式无法加载的问题页面样式是一个地址需要通过科学上网的方式访问否则你的登录页会加载很久并且看到的页面是这样的登录按钮没有样式文件渲染但是不影响登录功能的执行默认做了什么保护应用程序要求对应用程序的任何交互进行身份验证程序启动时生成一个默认用户生成一个默认的随机密码并将此密码记录在控制台上生成默认的登录表单和注销页面提供基于表单的登录和注销流程对于请求重定向到登录页面对于服务请求返回未经授权处理跨站请求伪造攻击处理会话劫持攻击写入以确保写入以处理嗅探攻击写入头来保护经过身份验证的资源写入以处理点击劫持攻击的底层原理官方文档的底层原理之所以默认帮助我们做了那么多事情它的底层原理是传统的过滤器下图展示了处理一个请求时过滤器和的工作流程因此我们可以在过滤器中对请求进行修改或增强是提供的一个实现可以在容器和容器之间建立桥梁通过使用这样就可以将容器中的实例放在容器中管理复杂的业务中不可能只有一个过滤器因此是提供的一个特殊的它允许通过将过滤器的工作委托给多个实例被使用负责查找当前的请求需要执行的列表可以有多个的配置决定使用哪个如果请求的是它首先匹配的模式因此只调用假设没有其他实例匹配那么将调用程序的启动和运行接口的实现加载了默认的个默认情况下将初始的用户名和密码存在了类中这个类中有一个静态内部类配置了默认的用户名和密码我们也可以将用户名密码配置在的配置文件中在中配置自定义用户名和密码第二章自定义配置基于内存的用户认证创建自定义配置实际开发的过程中我们需要应用程序更加灵活可以在中创建自定义配置文件官方文档自定义配置用来管理用户信息是的一个实现用来管理基于内存的用户信息创建一个文件定义一个类型是实现是项目总需要添加此注解项目中不需要此行设置断点可以查看创建的对象自定义用户名自定义密码自定义角色测试使用用户名密码登录基于内存的用户认证流程程序启动时创建对象创建对象封装用户名密码使用将存入内存校验用户时自动使用的方法从内存中获取对象在过滤器中的方法中将用户输入的用户名密码和从内存中获取到的用户信息进行比较进行用户认证基于数据库的数据源创建三个数据库表并插入测试数据创建数据库创建用户表唯一索引插入用户数据密码是引入依赖配置数据源数据源日志实体类接口接口实现测试基于数据库的用户认证基于数据库的用户认证流程程序启动时创建类实现接口在应用程序中初始化这个类的对象校验用户时自动使用的方法从数据库中获取对象在过滤器中的方法中将用户输入的用户名密码和从数据库中获取到的用户信息进行比较进行用户认证定义用户账号是否过期用户凭证是否过期用户是否未被锁定权限列表初始化修改中的方法如下或者直接在类上添加注解测试使用数据库中配置的用户名和密码进行登录的默认配置在中添加如下配置开启授权保护对所有请求开启授权保护已认证请求会自动被授权表单授权方式基本授权方式添加用户功能中添加方法接口中添加方法实现中添加方法自定义用户名自定义密码修改配置中添加方法使用测试中添加配置用于测试测试测试地址关闭攻击防御默认情况下开启了攻击防御的功能这要求请求参数中必须有一个隐藏的字段如下在方法中添加如下代码关闭攻击防御关闭攻击防御密码加密算法参考文档密码加密方式明文密码最初密码以明文形式存储在数据库中但是恶意用户可能会通过注入等手段获取到明文密码或者程序员将数据库数据泄露的情况也可能发生算法的接口用于对密码进行单向转换从而将密码安全地存储对密码单向转换需要用到哈希算法例如等哈希算法是单向的只能加密不能解密因此数据库中存储的是单向转换后的密码在进行用户身份验证时需要将用户输入的密码进行单向转换然后与数据库的密码进行比较因此如果发生数据泄露只有密码的单向哈希会被暴露由于哈希是单向的并且在给定哈希的情况下只能通过暴力破解的方式猜测密码彩虹表恶意用户创建称为彩虹表的查找表彩虹表就是一个庞大的针对各种可能的字母组合预先生成的哈希值集合有了它可以快速破解各类密码越是复杂的密码需要的彩虹表就越大主流的彩虹表都是以上目前主要的算法有加盐密码为了减轻彩虹表的效果开发人员开始使用加盐密码不再只使用密码作为哈希函数的输入而是为每个用户的密码生成随机字节称为盐盐和用户的密码将一起经过哈希函数运算生成一个唯一的哈希盐将以明文形式与用户的密码一起存储然后当用户尝试进行身份验证时盐和用户输入的密码一起经过哈希函数运算再与存储的密码进行比较唯一的盐意味着彩虹表不再有效因为对于每个盐和密码的组合哈希都是不同的自适应单向函数随着硬件的不断发展加盐哈希也不再安全原因是计算机可以每秒执行数十亿次哈希计算这意味着我们可以轻松地破解每个密码现在开发人员开始使用自适应单向函数来存储密码使用自适应单向函数验证密码时故意占用资源故意使用大量的内存或其他资源自适应单向函数允许配置一个工作因子随着硬件的改进而增加我们建议将工作因子调整到系统中验证密码需要约一秒钟的时间这种权衡是为了让攻击者难以破解密码自适应单向函数包括和使用广泛支持的算法来对密码进行哈希为了增加对密码破解的抵抗力故意设计得较慢和其他自适应单向函数一样应该调整其参数使其在您的系统上验证一个密码大约需要秒的时间的默认实现使用强度建议您在自己的系统上调整和测试强度参数以便验证密码时大约需要秒的时间使用算法对密码进行哈希处理是密码哈希比赛的获胜者为了防止在自定义硬件上进行密码破解是一种故意缓慢的算法需要大量内存与其他自适应单向函数一样它应该在您的系统上调整为大约秒来验证一个密码当前的实现需要使用库使用算法对密码进行哈希处理为了防止密码破解是一种故意缓慢的算法与其他自适应单向函数一样它应该在您的系统上调整为大约秒来验证一个密码当需要认证时这种算法是一个很好的选择使用算法对密码进行哈希处理为了防止在自定义硬件上进行密码破解是一种故意缓慢的算法需要大量内存与其他自适应单向函数一样它应该在您的系统上调整为大约秒来验证一个密码密码加密测试在测试类中编写一个测试方法工作因子默认值是最小值是最大值是值越大运算速度越慢明文密文即使明文密码相同每次生成的密文也不一致密码校验密码不一致表中存储的密码形式通过如下源码可以知道可以通过前缀动态获取和密码的形式类型一致的对象目的方便随时做密码策略的升级兼容数据库中的老版本密码策略生成的密码自定义登录页面创建登录创建登录页面登录登录错误的用户名和密码必须为使用动态参数表单中会自动生成隐藏字段用于防止攻击和登录页面保持一致即可自动进行登录认证必须为用户名必须为密码登录配置登录页面无需授权即可访问自定义表单用户名参数默认是自定义表单密码参数默认是登录失败的返回地址使用表单授权方式第三章前后端分离用户认证流程登录成功后调用登录失败后调用引入认证成功的响应成功结果处理获取用户身份信息创建结果对象登录成功转换成字符串返回响应配置认证成功时的处理认证失败响应失败结果处理获取错误信息创建结果对象转换成字符串返回响应配置认证失败时的处理注销响应注销结果处理创建结果对象注销成功转换成字符串返回响应配置注销成功时的处理请求未认证的接口实现接口当访问一个需要认证之后才能访问的接口的时候会使用将用户请求跳转到登录页面要求用户提供登录凭证这里我们也希望系统返回结果因此我们定义类实现接口获取错误信息创建结果对象需要登录转换成字符串返回响应配置错误处理请求未认证的接口跨域跨域全称是跨域资源共享它是浏览器的保护机制只允许网页请求统一域名下的服务同一域名指协议域名端口号都要保持一致如果有一项不同那么就是跨域请求在前后端分离的项目中需要解决跨域的问题在中解决跨域很简单在配置文件中添加如下配置即可跨域第四章身份认证用户认证信息基本概念在框架中和是一些与身份验证和授权相关的重要概念它们之间的关系如下是存储已认证用户详细信息的地方是从获取的内容包含当前已认证用户的信息表示用户的身份认证信息它包含了用户的和信息表示用户的身份标识它通常是一个表示用户的实体对象例如用户名可以通过对象的方法获取表示用户的凭证信息例如密码证书或其他认证凭据可以通过对象的方法获取表示用户被授予的权限总结起来用于管理当前线程的安全上下文存储已认证用户的详细信息其中包含了对象该对象包含了对象后者表示用户的身份验证信息包括用户的身份标识和用户的凭证信息在中获取用户信息存储认证对象的上下文认证对象用户名身份凭证脱敏权限创建结果对象会话并发处理后登录的账号会使先登录的账号失效实现处理器接口实现接口创建结果对象该账号已从其他设备登录转换成字符串返回响应配置会话管理第五章授权授权管理的实现在中非常灵活可以帮助应用程序实现以下两种常见的授权需求用户权限资源例如张三的权限是添加用户查看用户列表李四的权限是查看用户列表用户角色权限资源例如张三是角色是管理员李四的角色是普通用户管理员能做所有操作普通用户只能查看信息基于的授权用户权限资源需求具有权限的用户可以访问接口具有权限的用户可以访问接口配置权限开启授权保护具有权限的用户可以访问具有权限的用户可以访问对所有请求开启授权保护已认证的请求会被自动授权授予权限中的方法请求未授权的接口错误处理请求未认证的接口请求未授权的接口创建结果对象没有权限转换成字符串返回响应更多的例子用户角色资源需求角色为的用户才可以访问路径下的资源配置角色开启授权保护具有管理员角色的用户可以访问对所有请求开启授权保护已认证的请求会被自动授权授予角色中的方法用户角色权限资源基于角色的访问控制是一种常用的数据库设计方案它将用户的权限分配和管理与角色相关联以下是一个基本的数据库设计方案的示例用户表包含用户的基本信息例如用户名密码和其他身份验证信息列名数据类型描述用户用户名密码电子邮件地址角色表存储所有可能的角色及其描述列名数据类型描述角色角色名称角色描述权限表定义系统中所有可能的权限列名数据类型描述权限权限名称权限描述用户角色关联表将用户与角色关联起来列名数据类型描述用户角色关联用户角色角色权限关联表将角色与权限关联起来列名数据类型描述角色权限关联角色权限在这个设计方案中用户可以被分配一个或多个角色而每个角色又可以具有一个或多个权限通过对用户角色关联和角色权限关联表进行操作可以实现灵活的权限管理和访问控制当用户尝试访问系统资源时系统可以根据用户的角色和权限决定是否允许访问这样的设计方案使得权限管理更加简单和可维护因为只需调整角色和权限的分配即可而不需要针对每个用户进行单独的设置遇到的问题检查拒绝原因会在控制台打印拒绝的原因当前用户用户权限拒绝原因权限不足基于方法的授权开启方法授权在配置文件中添加如下注解给用户授予角色和权限中的方法常用授权注解用户必须有角色并且用户名是才能访问此方法用户必须有权限才能访问此方法更多的例子第六章简介是什么表示授权是的简称表示开放连在一起就表示开放授权是一种开放授权协议最简向导的角色协议包含以下角色资源所有者即用户资源的拥有人想要通过客户应用访问资源服务器上的资源客户应用通常是一个或者无线应用它需要访问用户的受保护资源资源服务器存储受保护资源的服务器或定义了可以访问到资源的接收并验证客户端的访问令牌以决定是否授权访问资源授权服务器负责验证资源所有者的身份并向客户端颁发访问令牌的使用场景开放系统间授权社交登录在传统的身份验证中用户需要提供用户名和密码还有很多网站登录时允许使用第三方网站的身份这称为第三方登录所谓第三方登录实质就是授权用户想要登录网站网站让用户提供第三方网站的数据证明自己的身份获取第三方网站的身份数据就需要授权开放例如云冲印服务的实现现代微服务安全单块应用安全微服务安全企业内部应用认证授权单点登录身份识别与访问管理的四种授权模式阮一峰的四种方式阮一峰的网络日志四种模式授权码隐藏式密码式客户端凭证第一种方式授权码授权码指的是第三方应用先申请一个授权码然后再用该码获取令牌这种方式是最常用最复杂也是最安全的它适用于那些有后端的应用授权码通过前端传送令牌则是储存在后端而且所有与资源服务器的通信都在后端完成这样的前后端分离可以避免令牌泄漏注册客户应用客户应用如果想要访问资源服务器需要有凭证需要在授权服务器上注册客户应用注册后会获取到一个和第二种方式隐藏式隐藏式也叫简化模式有些应用是纯前端应用没有后端这时就不能用上面的方式了必须将令牌储存在前端规定了这种方式允许直接向前端颁发令牌这种方式没有授权码这个中间步骤所以称为隐藏式这种方式把令牌直接传给前端是很不安全的因此只能用于一些安全要求不高的场景并且令牌的有效期必须非常短通常就是会话期间有效浏览器关掉令牌就失效了将访问令牌包含在锚点中的好处锚点在请求中不会发送到服务器减少了泄漏令牌的风险第三种方式密码式密码式如果你高度信任某个应用也允许用户把用户名和密码直接告诉该应用该应用就使用你的密码申请令牌这种方式需要用户给出自己的用户名密码显然风险很大因此只适用于其他授权方式都无法采用的情况而且必须是用户高度信任的应用第四种方式凭证式凭证式也叫客户端模式适用于没有前端的命令行应用即在命令行下请求令牌这种方式给出的令牌是针对第三方应用的而不是针对用户的即有可能多个用户共享同一个令牌授权类型的选择中的相关角色回顾中的角色资源所有者客户应用资源服务器授权服务器中的实现客户应用客户端功能中包含资源服务器授权服务器它是在之上的一个单独的项目相关依赖资源服务器客户应用授权服务器授权登录的实现思路使用社交登录案例创建应用注册客户应用登录在开发者设置中找到创建一个为客户应用创建访问的凭据填写应用信息默认的重定向模板为是的唯一标识符获取应用程序生成应用程序密钥创建测试项目创建一个项目创建时引入如下依赖示例代码参考配置客户端属性创建创建页面启动应用程序启动程序并访问浏览器将被重定向到默认的自动生成的登录页面该页面显示了一个用于登录的链接点击链接浏览器将被重定向到进行身份验证使用账户凭据进行身份验证后用户会看到授权页面询问用户是否允许或拒绝客户应用访问上的用户数据点击允许以授权客户端访问用户的基本个人资料信息此时客户端访问的获取用户信息的接口获取基本个人资料信息并建立一个已认证的会话案例分析登录流程网站让用户跳转到并携带参数以及要求用户登录然后询问用户网站要求获取用户信息的权限你是否同意用户同意就会重定向回网站同时发回一个授权码网站使用授权码向请求令牌返回令牌网站使用令牌向请求用户数据返回用户数据网站使用用户数据登录是一个预定义的通用为一些知名资源服务提供商如预定义了一组默认的属性例如授权令牌和用户信息通常不经常变化因此提供默认值以减少所需的配置因此当我们配置客户端时只需要提供和属性授权回调地址向客户应用发送回调请求并携带授权码授权页面客户应用使用授权码向请求令牌客户应用使用令牌向请求用户数据属性显示中获取的哪个属性的信息登录页面超链接的文本',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-26 15:27:14',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://fn-civets.s.odn.cc" title="CivetsNas"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="CivetsNas"/><span class="back-menu-item-text">CivetsNas</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Civets</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">24</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-01-24T03:20:06.000Z" title="发表于 2024-01-24 11:20:06">2024-01-24</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-03-26T07:27:14.197Z" title="更新于 2025-03-26 15:27:14">2025-03-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2024/01/24/SpringSecurity%E5%92%8COAuth2/%E7%AC%94%E8%AE%B0/"><header><h1 id="CrawlerTitle" itemprop="name headline">无题</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">civets</span><time itemprop="dateCreated datePublished" datetime="2024-01-24T03:20:06.000Z" title="发表于 2024-01-24 11:20:06">2024-01-24</time><time itemprop="dateCreated datePublished" datetime="2025-03-26T07:27:14.197Z" title="更新于 2025-03-26 15:27:14">2025-03-26</time></header><h1 id="第一章-Spring-Security快速入门"><a href="#第一章-Spring-Security快速入门" class="headerlink" title="第一章 Spring Security快速入门"></a>第一章 Spring Security快速入门</h1><p><strong>官方文档：</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/index.html">https://docs.spring.io/spring-security/reference/index.html</a></p>
<p><strong>功能：</strong></p>
<ul>
<li>身份认证（authentication）</li>
<li>授权（authorization）</li>
<li>防御常见攻击（protection against common attacks）</li>
</ul>
<p><strong>身份认证：</strong></p>
<ul>
<li>身份认证是验证<code>谁正在访问系统资源</code>，判断用户是否为合法用户。认证用户的常见方式是要求用户输入用户名和密码。</li>
</ul>
<p><strong>授权：</strong></p>
<ul>
<li>用户进行身份认证后，系统会控制<code>谁能访问哪些资源</code>，这个过程叫做授权。用户无法访问没有权限的资源。</li>
</ul>
<p><strong>防御常见攻击：</strong></p>
<ul>
<li>CSRF</li>
<li>HTTP Headers</li>
<li>HTTP Requests</li>
</ul>
<h2 id="1、身份认证（authentication）"><a href="#1、身份认证（authentication）" class="headerlink" title="1、身份认证（authentication）"></a>1、身份认证（authentication）</h2><p><strong>官方代码示例：</strong><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security-samples/tree/main">GitHub - spring-projects&#x2F;spring-security-samples</a></p>
<h3 id="1-1、创建Spring-Boot项目"><a href="#1-1、创建Spring-Boot项目" class="headerlink" title="1.1、创建Spring Boot项目"></a>1.1、创建Spring Boot项目</h3><p>项目名：security-demo</p>
<p>JDK：17</p>
<p>SpringBoot：3.2.0（依赖了Spring Security 6.2.0）</p>
<p>Dependencies：Spring Web、Spring Security、Thymeleaf</p>
<h3 id="1-2、创建IndexController"><a href="#1-2、创建IndexController" class="headerlink" title="1.2、创建IndexController"></a>1.2、创建IndexController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3、创建index-html"><a href="#1-3、创建index-html" class="headerlink" title="1.3、创建index.html"></a>1.3、创建index.html</h3><p>在路径resources&#x2F;templates中创建index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello Security!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Security<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--通过使用@&#123;/logout&#125;，Thymeleaf将自动处理生成正确的URL，以适应当前的上下文路径。</span></span><br><span class="line"><span class="comment">这样，无论应用程序部署在哪个上下文路径下，生成的URL都能正确地指向注销功能。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/logout&#125;&quot;</span>&gt;</span>Log Out<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="1-4、启动项目测试Controller"><a href="#1-4、启动项目测试Controller" class="headerlink" title="1.4、启动项目测试Controller"></a>1.4、启动项目测试Controller</h3><p>浏览器中访问：<a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a></p>
<p>**浏览器自动跳转到登录页面：**<a target="_blank" rel="noopener" href="http://localhost:8080/login">http://localhost:8080/login</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20230410140908841.png" alt="image-20230410140908841"></p>
<p>输入用户名：user</p>
<p>输入密码：在控制台的启动日志中查找初始的默认密码</p>
<p>点击”Sign in”进行登录，浏览器就跳转到了index页面</p>
<h3 id="1-5、注意事项"><a href="#1-5、注意事项" class="headerlink" title="1.5、注意事项"></a>1.5、注意事项</h3><h4 id="1-5-1、-logout-的作用"><a href="#1-5-1、-logout-的作用" class="headerlink" title="1.5.1、@{&#x2F;logout}的作用"></a>1.5.1、@{&#x2F;logout}的作用</h4><p>通过使用@{&#x2F;logout}，Thymeleaf将自动处理生成正确的URL，以适应当前的上下文路径。这样，无论应用程序部署在哪个上下文路径下，生成的URL都能正确地指向注销功能。</p>
<p>例如：如果我们在配置文件中添加如下内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.servlet.context-path=/demo</span></span><br></pre></td></tr></table></figure>

<p>那么@{&#x2F;logout}可以自动处理url为正确的相对路径</p>
<p>但是如果是普通的&#x2F;logout，路径就会不正确</p>
<h4 id="1-5-2、页面样式无法加载的问题"><a href="#1-5-2、页面样式无法加载的问题" class="headerlink" title="1.5.2、页面样式无法加载的问题"></a>1.5.2、页面样式无法加载的问题</h4><p>页面样式bootstrap.min.css是一个CDN地址，需要通过科学上网的方式访问</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231130152247055.png" alt="image-20231130152247055"></p>
<p>否则你的登录页会加载很久，并且看到的页面是这样的（登录按钮没有样式文件渲染，但是不影响登录功能的执行）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231130152345471.png" alt="image-20231130152345471"></p>
<h3 id="1-6、Spring-Security默认做了什么"><a href="#1-6、Spring-Security默认做了什么" class="headerlink" title="1.6、Spring Security默认做了什么"></a>1.6、Spring Security默认做了什么</h3><ul>
<li>保护应用程序URL，要求对应用程序的任何交互进行身份验证。</li>
<li>程序启动时生成一个默认用户“user”。</li>
<li>生成一个默认的随机密码，并将此密码记录在控制台上。</li>
<li>生成默认的登录表单和注销页面。</li>
<li>提供基于表单的登录和注销流程。</li>
<li>对于Web请求，重定向到登录页面；</li>
<li>对于服务请求，返回401未经授权。</li>
<li>处理跨站请求伪造（CSRF）攻击。</li>
<li>处理会话劫持攻击。</li>
<li>写入Strict-Transport-Security以确保HTTPS。</li>
<li>写入X-Content-Type-Options以处理嗅探攻击。</li>
<li>写入Cache Control头来保护经过身份验证的资源。</li>
<li>写入X-Frame-Options以处理点击劫持攻击。</li>
</ul>
<h2 id="2、Spring-Security-的底层原理"><a href="#2、Spring-Security-的底层原理" class="headerlink" title="2、Spring Security 的底层原理"></a>2、Spring Security 的底层原理</h2><p><strong>官方文档：</strong><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/architecture.html">Spring Security的底层原理</a></p>
<p>Spring Security之所以默认帮助我们做了那么多事情，它的底层原理是传统的<code>Servlet过滤器</code></p>
<h3 id="2-1、Filter"><a href="#2-1、Filter" class="headerlink" title="2.1、Filter"></a>2.1、Filter</h3><p>下图展示了处理一个Http请求时，过滤器和Servlet的工作流程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/filterchain.png" alt="filterchain"></p>
<p>因此我们可以在过滤器中对请求进行修改或增强。</p>
<h3 id="2-2、DelegatingFilterProxy"><a href="#2-2、DelegatingFilterProxy" class="headerlink" title="2.2、DelegatingFilterProxy"></a>2.2、DelegatingFilterProxy</h3><p>DelegatingFilterProxy 是 Spring Security 提供的一个 Filter 实现，可以在 Servlet 容器和 Spring 容器之间建立桥梁。通过使用 DelegatingFilterProxy，这样就可以将Servlet容器中的 Filter 实例放在 Spring 容器中管理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/delegatingfilterproxy.png" alt="delegatingfilterproxy"></p>
<h3 id="2-3、FilterChainProxy"><a href="#2-3、FilterChainProxy" class="headerlink" title="2.3、FilterChainProxy"></a>2.3、FilterChainProxy</h3><p>复杂的业务中不可能只有一个过滤器。因此FilterChainProxy是Spring Security提供的一个特殊的Filter，它允许通过SecurityFilterChain将过滤器的工作委托给多个Bean Filter实例。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/filterchainproxy.png" alt="filterchainproxy"></p>
<h3 id="2-4、SecurityFilterChain"><a href="#2-4、SecurityFilterChain" class="headerlink" title="2.4、SecurityFilterChain"></a>2.4、SecurityFilterChain</h3><p>SecurityFilterChain 被 FilterChainProxy 使用，负责查找当前的请求需要执行的Security Filter列表。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/securityfilterchain.png" alt="securityfilterchain"></p>
<h3 id="2-5、Multiple-SecurityFilterChain"><a href="#2-5、Multiple-SecurityFilterChain" class="headerlink" title="2.5、Multiple SecurityFilterChain"></a>2.5、Multiple SecurityFilterChain</h3><p>可以有多个SecurityFilterChain的配置，FilterChainProxy决定使用哪个SecurityFilterChain。如果请求的URL是&#x2F;api&#x2F;messages&#x2F;，它首先匹配SecurityFilterChain0的模式&#x2F;api&#x2F;**，因此只调用SecurityFilterChain 0。假设没有其他SecurityFilterChain实例匹配，那么将调用SecurityFilterChain n。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/multi-securityfilterchain-17016804731631.png" alt="multi securityfilterchain"></p>
<h2 id="3、程序的启动和运行"><a href="#3、程序的启动和运行" class="headerlink" title="3、程序的启动和运行"></a>3、程序的启动和运行</h2><h3 id="3-1、DefaultSecurityFilterChain"><a href="#3-1、DefaultSecurityFilterChain" class="headerlink" title="3.1、DefaultSecurityFilterChain"></a>3.1、DefaultSecurityFilterChain</h3><p>SecurityFilterChain接口的实现，加载了默认的16个Filter</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231204230216259.png" alt="image-20231204230216259"></p>
<h3 id="3-2、SecurityProperties"><a href="#3-2、SecurityProperties" class="headerlink" title="3.2、SecurityProperties"></a>3.2、SecurityProperties</h3><p>默认情况下Spring Security将初始的用户名和密码存在了SecurityProperties类中。这个类中有一个静态内部类User，配置了默认的用户名（name &#x3D; “user”）和密码（password &#x3D; uuid）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231205164049257.png" alt="image-20231205164049257"></p>
<p>我们也可以将用户名、密码配置在SpringBoot的配置文件中：在application.properties中配置自定义用户名和密码</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.security.user.name</span>=<span class="string">user</span></span><br><span class="line"><span class="attr">spring.security.user.password</span>=<span class="string">123</span></span><br></pre></td></tr></table></figure>





<h1 id="第二章-Spring-Security自定义配置"><a href="#第二章-Spring-Security自定义配置" class="headerlink" title="第二章 Spring Security自定义配置"></a>第二章 Spring Security自定义配置</h1><h2 id="1、基于内存的用户认证"><a href="#1、基于内存的用户认证" class="headerlink" title="1、基于内存的用户认证"></a>1、基于内存的用户认证</h2><h3 id="1-1、创建自定义配置"><a href="#1-1、创建自定义配置" class="headerlink" title="1.1、创建自定义配置"></a>1.1、创建自定义配置</h3><p>实际开发的过程中，我们需要应用程序更加灵活，可以在SpringSecurity中创建自定义配置文件</p>
<p><strong>官方文档：</strong><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/configuration/java.html">Java自定义配置</a></p>
<p><strong>UserDetailsService</strong>用来管理用户信息，<strong>InMemoryUserDetailsManager</strong>是UserDetailsService的一个实现，用来管理基于内存的用户信息。</p>
<p>创建一个WebSecurityConfig文件：</p>
<p>定义一个@Bean，类型是UserDetailsService，实现是InMemoryUserDetailsManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span><span class="comment">//Spring项目总需要添加此注解，SpringBoot项目中不需要</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        manager.createUser( <span class="comment">//此行设置断点可以查看创建的user对象</span></span><br><span class="line">            User</span><br><span class="line">            .withDefaultPasswordEncoder()</span><br><span class="line">            .username(<span class="string">&quot;huan&quot;</span>) <span class="comment">//自定义用户名</span></span><br><span class="line">            .password(<span class="string">&quot;password&quot;</span>) <span class="comment">//自定义密码</span></span><br><span class="line">            .roles(<span class="string">&quot;USER&quot;</span>) <span class="comment">//自定义角色</span></span><br><span class="line">            .build()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>**测试：**使用用户名huan，密码password登录</p>
<h3 id="1-2、基于内存的用户认证流程"><a href="#1-2、基于内存的用户认证流程" class="headerlink" title="1.2、基于内存的用户认证流程"></a>1.2、基于内存的用户认证流程</h3><ul>
<li>程序启动时：<ul>
<li>创建<code>InMemoryUserDetailsManager</code>对象</li>
<li>创建<code>User</code>对象，封装用户名密码</li>
<li>使用InMemoryUserDetailsManager<code>将User存入内存</code></li>
</ul>
</li>
<li>校验用户时：<ul>
<li>SpringSecurity自动使用<code>InMemoryUserDetailsManager</code>的<code>loadUserByUsername</code>方法从<code>内存中</code>获取User对象</li>
<li>在<code>UsernamePasswordAuthenticationFilter</code>过滤器中的<code>attemptAuthentication</code>方法中将用户输入的用户名密码和从内存中获取到的用户信息进行比较，进行用户认证</li>
</ul>
</li>
</ul>
<h2 id="2、基于数据库的数据源"><a href="#2、基于数据库的数据源" class="headerlink" title="2、基于数据库的数据源"></a>2、基于数据库的数据源</h2><h3 id="2-1、SQL"><a href="#2-1、SQL" class="headerlink" title="2.1、SQL"></a>2.1、SQL</h3><p>创建三个数据库表并插入测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE `security<span class="operator">-</span>demo`;</span><br><span class="line">USE `security<span class="operator">-</span>demo`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建用户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> `<span class="keyword">user</span>`(</span><br><span class="line">	`id` <span class="type">INT</span> <span class="keyword">NOT NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">	`username` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">	`password` <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`enabled` <span class="type">BOOLEAN</span> <span class="keyword">NOT NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 唯一索引</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX `user_username_uindex` <span class="keyword">ON</span> `<span class="keyword">user</span>`(`username`); </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入用户数据(密码是 &quot;abc&quot; )</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> `<span class="keyword">user</span>` (`username`, `password`, `enabled`) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;&#123;bcrypt&#125;$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW&#x27;</span>, <span class="literal">TRUE</span>),</span><br><span class="line">(<span class="string">&#x27;Helen&#x27;</span>, <span class="string">&#x27;&#123;bcrypt&#125;$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW&#x27;</span>, <span class="literal">TRUE</span>),</span><br><span class="line">(<span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;&#123;bcrypt&#125;$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW&#x27;</span>, <span class="literal">TRUE</span>);</span><br></pre></td></tr></table></figure>



<h3 id="2-2、引入依赖"><a href="#2-2、引入依赖" class="headerlink" title="2.2、引入依赖"></a>2.2、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-3、配置数据源"><a href="#2-3、配置数据源" class="headerlink" title="2.3、配置数据源"></a>2.3、配置数据源</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MySQL数据源</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security-demo</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment">#SQL日志</span></span><br><span class="line"><span class="attr">mybatis-plus.configuration.log-impl</span>=<span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4、实体类"><a href="#2-4、实体类" class="headerlink" title="2.4、实体类"></a>2.4、实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.entity;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean enabled;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5、Mapper"><a href="#2-5、Mapper" class="headerlink" title="2.5、Mapper"></a>2.5、Mapper</h3><p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>xml</p>
<p>resources&#x2F;mapper&#x2F;UserMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.securitydemo.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-6、Service"><a href="#2-6、Service" class="headerlink" title="2.6、Service"></a>2.6、Service</h3><p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-7、Controller"><a href="#2-7、Controller" class="headerlink" title="2.7、Controller"></a>2.7、Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">public</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getList</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.list();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>测试：</strong><a target="_blank" rel="noopener" href="http://localhost:8080/demo/user/list">localhost:8080&#x2F;demo&#x2F;user&#x2F;list</a></p>
<h2 id="3、基于数据库的用户认证"><a href="#3、基于数据库的用户认证" class="headerlink" title="3、基于数据库的用户认证"></a>3、基于数据库的用户认证</h2><h3 id="3-1、基于数据库的用户认证流程"><a href="#3-1、基于数据库的用户认证流程" class="headerlink" title="3.1、基于数据库的用户认证流程"></a>3.1、基于数据库的用户认证流程</h3><ul>
<li>程序启动时：<ul>
<li>创建<code>DBUserDetailsManager</code>类，实现接口 UserDetailsManager, UserDetailsPasswordService</li>
<li>在应用程序中初始化这个类的对象</li>
</ul>
</li>
<li>校验用户时：<ul>
<li>SpringSecurity自动使用<code>DBUserDetailsManager</code>的<code>loadUserByUsername</code>方法从<code>数据库中</code>获取User对象</li>
<li>在<code>UsernamePasswordAuthenticationFilter</code>过滤器中的<code>attemptAuthentication</code>方法中将用户输入的用户名密码和从数据库中获取到的用户信息进行比较，进行用户认证</li>
</ul>
</li>
</ul>
<h3 id="3-2、定义DBUserDetailsManager"><a href="#3-2、定义DBUserDetailsManager" class="headerlink" title="3.2、定义DBUserDetailsManager"></a>3.2、定义DBUserDetailsManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBUserDetailsManager</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsManager</span>, UserDetailsPasswordService &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(username);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.core.userdetails.User(</span><br><span class="line">                    user.getUsername(),</span><br><span class="line">                    user.getPassword(),</span><br><span class="line">                    user.getEnabled(),</span><br><span class="line">                    <span class="literal">true</span>, <span class="comment">//用户账号是否过期</span></span><br><span class="line">                    <span class="literal">true</span>, <span class="comment">//用户凭证是否过期</span></span><br><span class="line">                    <span class="literal">true</span>, <span class="comment">//用户是否未被锁定</span></span><br><span class="line">                    authorities); <span class="comment">//权限列表</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">updatePassword</span><span class="params">(UserDetails user, String newPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">(String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changePassword</span><span class="params">(String oldPassword, String newPassword)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">userExists</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-3、初始化UserDetailsService"><a href="#3-3、初始化UserDetailsService" class="headerlink" title="3.3、初始化UserDetailsService"></a>3.3、初始化UserDetailsService</h3><p>修改WebSecurityConfig中的userDetailsService方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DBUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DBUserDetailsManager</span>();</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>或者直接在DBUserDetailsManager类上添加@Component注解</strong></p>
<p>**测试：**使用数据库中配置的用户名和密码进行登录</p>
<h2 id="4、SpringSecurity的默认配置"><a href="#4、SpringSecurity的默认配置" class="headerlink" title="4、SpringSecurity的默认配置"></a>4、SpringSecurity的默认配置</h2><p>在WebSecurityConfig中添加如下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//authorizeRequests()：开启授权保护</span></span><br><span class="line">    <span class="comment">//anyRequest()：对所有请求开启授权保护</span></span><br><span class="line">    <span class="comment">//authenticated()：已认证请求会自动被授权</span></span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests(authorize -&gt; authorize.anyRequest().authenticated())</span><br><span class="line">        .formLogin(withDefaults())<span class="comment">//表单授权方式</span></span><br><span class="line">        .httpBasic(withDefaults());<span class="comment">//基本授权方式</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> http.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5、添加用户功能"><a href="#5、添加用户功能" class="headerlink" title="5、添加用户功能"></a>5、添加用户功能</h2><h3 id="5-1、Controller"><a href="#5-1、Controller" class="headerlink" title="5.1、Controller"></a>5.1、Controller</h3><p>UserController中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">    userService.saveUserDetails(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2、Service"><a href="#5-2、Service" class="headerlink" title="5.2、Service"></a>5.2、Service</h3><p>UserService接口中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">saveUserDetails</span><span class="params">(User user)</span>;</span><br></pre></td></tr></table></figure>

<p>UserServiceImpl实现中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DBUserDetailsManager dbUserDetailsManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUserDetails</span><span class="params">(User user)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> org.springframework.security.core.userdetails.User</span><br><span class="line">            .withDefaultPasswordEncoder()</span><br><span class="line">            .username(user.getUsername()) <span class="comment">//自定义用户名</span></span><br><span class="line">            .password(user.getPassword()) <span class="comment">//自定义密码</span></span><br><span class="line">            .build();</span><br><span class="line">    dbUserDetailsManager.createUser(userDetails);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-3、修改配置"><a href="#5-3、修改配置" class="headerlink" title="5.3、修改配置"></a>5.3、修改配置</h3><p>DBUserDetailsManager中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">(UserDetails userDetails)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setUsername(userDetails.getUsername());</span><br><span class="line">    user.setPassword(userDetails.getPassword());</span><br><span class="line">    user.setEnabled(<span class="literal">true</span>);</span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-4、使用Swagger测试"><a href="#5-4、使用Swagger测试" class="headerlink" title="5.4、使用Swagger测试"></a>5.4、使用Swagger测试</h3><p>pom中添加配置用于测试</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--swagger测试--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-openapi3-jakarta-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>**Swagger测试地址：**<a target="_blank" rel="noopener" href="http://localhost:8080/demo/doc.html">http://localhost:8080/demo/doc.html</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231206022701725.png" alt="image-20231206022701725"></p>
<h3 id="5-5、关闭csrf攻击防御"><a href="#5-5、关闭csrf攻击防御" class="headerlink" title="5.5、关闭csrf攻击防御"></a>5.5、关闭csrf攻击防御</h3><p>默认情况下SpringSecurity开启了csrf攻击防御的功能，这要求请求参数中必须有一个隐藏的**_csrf**字段，如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231206023030864.png" alt="image-20231206023030864"></p>
<p>在filterChain方法中添加如下代码，关闭csrf攻击防御</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关闭csrf攻击防御</span></span><br><span class="line">http.csrf((csrf) -&gt; &#123;</span><br><span class="line">    csrf.disable();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="6、密码加密算法"><a href="#6、密码加密算法" class="headerlink" title="6、密码加密算法"></a>6、密码加密算法</h2><p><strong>参考文档：</strong><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/features/authentication/password-storage.html">Password Storage :: Spring Security</a></p>
<h3 id="6-1、密码加密方式"><a href="#6-1、密码加密方式" class="headerlink" title="6.1、密码加密方式"></a>6.1、密码加密方式</h3><p><strong>明文密码：</strong></p>
<p>最初，密码以明文形式存储在数据库中。但是恶意用户可能会通过SQL注入等手段获取到明文密码，或者程序员将数据库数据泄露的情况也可能发生。</p>
<p><strong>Hash算法：</strong></p>
<p>Spring Security的<code>PasswordEncoder</code>接口用于对密码进行<code>单向转换</code>，从而将密码安全地存储。对密码单向转换需要用到<code>哈希算法</code>，例如MD5、SHA-256、SHA-512等，哈希算法是单向的，<code>只能加密，不能解密</code>。</p>
<p>因此，<code>数据库中存储的是单向转换后的密码</code>，Spring Security在进行用户身份验证时需要将用户输入的密码进行单向转换，然后与数据库的密码进行比较。</p>
<p>因此，如果发生数据泄露，只有密码的单向哈希会被暴露。由于哈希是单向的，并且在给定哈希的情况下只能通过<code>暴力破解的方式猜测密码</code>。</p>
<p><strong>彩虹表：</strong></p>
<p>恶意用户创建称为<code>彩虹表</code>的查找表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">彩虹表就是一个庞大的、针对各种可能的字母组合预先生成的哈希值集合，有了它可以快速破解各类密码。越是复杂的密码，需要的彩虹表就越大，主流的彩虹表都是100G以上，目前主要的算法有LM, NTLM, MD5, SHA1, MYSQLSHA1, HALFLMCHALL, NTLMCHALL, ORACLE-SYSTEM, MD5-HALF。</span><br></pre></td></tr></table></figure>



<p><strong>加盐密码：</strong></p>
<p>为了减轻彩虹表的效果，开发人员开始使用加盐密码。不再只使用密码作为哈希函数的输入，而是为每个用户的密码生成随机字节（称为盐）。盐和用户的密码将一起经过哈希函数运算，生成一个唯一的哈希。盐将以明文形式与用户的密码一起存储。然后，当用户尝试进行身份验证时，盐和用户输入的密码一起经过哈希函数运算，再与存储的密码进行比较。唯一的盐意味着彩虹表不再有效，因为对于每个盐和密码的组合，哈希都是不同的。</p>
<p><strong>自适应单向函数：</strong></p>
<p>随着硬件的不断发展，加盐哈希也不再安全。原因是，计算机可以每秒执行数十亿次哈希计算。这意味着我们可以轻松地破解每个密码。</p>
<p>现在，开发人员开始使用自适应单向函数来存储密码。使用自适应单向函数验证密码时，<code>故意占用资源（故意使用大量的CPU、内存或其他资源）</code>。自适应单向函数允许配置一个<code>“工作因子”</code>，随着硬件的改进而增加。我们建议将“工作因子”调整到系统中验证密码需要约一秒钟的时间。这种权衡是为了<code>让攻击者难以破解密码</code>。</p>
<p>自适应单向函数包括<code>bcrypt、PBKDF2、scrypt和argon2</code>。</p>
<h3 id="6-2、PasswordEncoder"><a href="#6-2、PasswordEncoder" class="headerlink" title="6.2、PasswordEncoder"></a>6.2、PasswordEncoder</h3><p><strong>BCryptPasswordEncoder</strong></p>
<p>使用广泛支持的bcrypt算法来对密码进行哈希。为了增加对密码破解的抵抗力，bcrypt故意设计得较慢。和其他自适应单向函数一样，应该调整其参数，使其在您的系统上验证一个密码大约需要1秒的时间。BCryptPasswordEncoder的默认实现使用强度10。建议您在自己的系统上调整和测试强度参数，以便验证密码时大约需要1秒的时间。</p>
<p><strong>Argon2PasswordEncoder</strong></p>
<p>使用Argon2算法对密码进行哈希处理。Argon2是密码哈希比赛的获胜者。为了防止在自定义硬件上进行密码破解，Argon2是一种故意缓慢的算法，需要大量内存。与其他自适应单向函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。当前的Argon2PasswordEncoder实现需要使用BouncyCastle库。</p>
<p><strong>Pbkdf2PasswordEncoder</strong></p>
<p>使用PBKDF2算法对密码进行哈希处理。为了防止密码破解，PBKDF2是一种故意缓慢的算法。与其他自适应单向函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。当需要FIPS认证时，这种算法是一个很好的选择。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20230421184645177.png" alt="image-20230421184645177"></p>
<p><strong>SCryptPasswordEncoder</strong> </p>
<p>使用scrypt算法对密码进行哈希处理。为了防止在自定义硬件上进行密码破解，scrypt是一种故意缓慢的算法，需要大量内存。与其他自适应单向函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。</p>
<h3 id="6-3、密码加密测试"><a href="#6-3、密码加密测试" class="headerlink" title="6.3、密码加密测试"></a>6.3、密码加密测试</h3><p>在测试类中编写一个测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPassword</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工作因子，默认值是10，最小值是4，最大值是31，值越大运算速度越慢</span></span><br><span class="line">    <span class="type">PasswordEncoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>(<span class="number">4</span>);</span><br><span class="line">    <span class="comment">//明文：&quot;password&quot;</span></span><br><span class="line">    <span class="comment">//密文：result，即使明文密码相同，每次生成的密文也不一致</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> encoder.encode(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">    System.out.println(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//密码校验</span></span><br><span class="line">    Assert.isTrue(encoder.matches(<span class="string">&quot;password&quot;</span>, result), <span class="string">&quot;密码不一致&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-4、DelegatingPasswordEncoder"><a href="#6-4、DelegatingPasswordEncoder" class="headerlink" title="6.4、DelegatingPasswordEncoder"></a>6.4、DelegatingPasswordEncoder</h3><ul>
<li>表中存储的密码形式：<code>&#123;bcrypt&#125;</code>$2a$10$GRLdNijSQMUvl&#x2F;au9ofL.eDwmoohzzS7.rmNSJZ.0FxO&#x2F;BTk76klW</li>
<li>通过如下源码可以知道：可以通过<code>&#123;bcrypt&#125;</code>前缀动态获取和密码的形式类型一致的PasswordEncoder对象</li>
<li>目的：方便随时做密码策略的升级，兼容数据库中的老版本密码策略生成的密码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231209011827867.png" alt="image-20231209011827867"></p>
<h2 id="7、自定义登录页面"><a href="#7、自定义登录页面" class="headerlink" title="7、自定义登录页面"></a>7、自定义登录页面</h2><h3 id="7-1、创建登录Controller"><a href="#7-1、创建登录Controller" class="headerlink" title="7.1、创建登录Controller"></a>7.1、创建登录Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2、创建登录页面"><a href="#7-2、创建登录页面" class="headerlink" title="7.2、创建登录页面"></a>7.2、创建登录页面</h3><p>resources&#x2F;templates&#x2F;login.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;param.error&#125;&quot;</span>&gt;</span></span><br><span class="line">    错误的用户名和密码.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--method必须为&quot;post&quot;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--th:action=&quot;@&#123;/login&#125;&quot; ，</span></span><br><span class="line"><span class="comment">使用动态参数，表单中会自动生成_csrf隐藏字段，用于防止csrf攻击</span></span><br><span class="line"><span class="comment">login: 和登录页面保持一致即可，SpringSecurity自动进行登录认证--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/login&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--name必须为&quot;username&quot;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;用户名&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--name必须为&quot;password&quot;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;密码&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="7-3、配置SecurityFilterChain"><a href="#7-3、配置SecurityFilterChain" class="headerlink" title="7.3、配置SecurityFilterChain"></a>7.3、配置SecurityFilterChain</h3><p>SecurityConfiguration：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.formLogin( form -&gt; &#123;</span><br><span class="line">    form</span><br><span class="line">        .loginPage(<span class="string">&quot;/login&quot;</span>).permitAll() <span class="comment">//登录页面无需授权即可访问</span></span><br><span class="line">        .usernameParameter(<span class="string">&quot;username&quot;</span>) <span class="comment">//自定义表单用户名参数，默认是username</span></span><br><span class="line">        .passwordParameter(<span class="string">&quot;password&quot;</span>) <span class="comment">//自定义表单密码参数，默认是password</span></span><br><span class="line">        .failureUrl(<span class="string">&quot;/login?error&quot;</span>) <span class="comment">//登录失败的返回地址</span></span><br><span class="line">        ;</span><br><span class="line">&#125;); <span class="comment">//使用表单授权方式</span></span><br></pre></td></tr></table></figure>



<h1 id="第三章-前后端分离"><a href="#第三章-前后端分离" class="headerlink" title="第三章 前后端分离"></a>第三章 前后端分离</h1><h2 id="1、用户认证流程"><a href="#1、用户认证流程" class="headerlink" title="1、用户认证流程"></a>1、用户认证流程</h2><ul>
<li>登录成功后调用：AuthenticationSuccessHandler</li>
<li>登录失败后调用：AuthenticationFailureHandler</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/usernamepasswordauthenticationfilter-16822329079281.png" alt="usernamepasswordauthenticationfilter"></p>
<h2 id="2、引入fastjson"><a href="#2、引入fastjson" class="headerlink" title="2、引入fastjson"></a>2、引入fastjson</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="3、认证成功的响应"><a href="#3、认证成功的响应" class="headerlink" title="3、认证成功的响应"></a>3、认证成功的响应</h2><h3 id="3-1、成功结果处理"><a href="#3-1、成功结果处理" class="headerlink" title="3.1、成功结果处理"></a>3.1、成功结果处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取用户身份信息</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> authentication.getPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建结果对象</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        result.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;data&quot;</span>, principal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换成json字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回响应</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2、SecurityFilterChain配置"><a href="#3-2、SecurityFilterChain配置" class="headerlink" title="3.2、SecurityFilterChain配置"></a>3.2、SecurityFilterChain配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">form.successHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>()) <span class="comment">//认证成功时的处理</span></span><br></pre></td></tr></table></figure>



<h2 id="4、认证失败响应"><a href="#4、认证失败响应" class="headerlink" title="4、认证失败响应"></a>4、认证失败响应</h2><h3 id="4-1、失败结果处理"><a href="#4-1、失败结果处理" class="headerlink" title="4.1、失败结果处理"></a>4.1、失败结果处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取错误信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">localizedMessage</span> <span class="operator">=</span> exception.getLocalizedMessage();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建结果对象</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        result.put(<span class="string">&quot;message&quot;</span>, localizedMessage);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换成json字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回响应</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2SecurityFilterChain配置"><a href="#4-2SecurityFilterChain配置" class="headerlink" title="4.2SecurityFilterChain配置"></a>4.2SecurityFilterChain配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">form.failureHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationFailureHandler</span>()) <span class="comment">//认证失败时的处理</span></span><br></pre></td></tr></table></figure>



<h2 id="5、注销响应"><a href="#5、注销响应" class="headerlink" title="5、注销响应"></a>5、注销响应</h2><h3 id="5-1、注销结果处理"><a href="#5-1、注销结果处理" class="headerlink" title="5.1、注销结果处理"></a>5.1、注销结果处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建结果对象</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        result.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;注销成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换成json字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回响应</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2、SecurityFilterChain配置"><a href="#5-2、SecurityFilterChain配置" class="headerlink" title="5.2、SecurityFilterChain配置"></a>5.2、SecurityFilterChain配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.logout(logout -&gt; &#123;</span><br><span class="line">    logout.logoutSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyLogoutSuccessHandler</span>()); <span class="comment">//注销成功时的处理</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="6、请求未认证的接口"><a href="#6、请求未认证的接口" class="headerlink" title="6、请求未认证的接口"></a>6、请求未认证的接口</h2><h3 id="6-1、实现AuthenticationEntryPoint接口"><a href="#6-1、实现AuthenticationEntryPoint接口" class="headerlink" title="6.1、实现AuthenticationEntryPoint接口"></a>6.1、实现AuthenticationEntryPoint接口</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">Servlet Authentication Architecture :: Spring Security</a></p>
<p>当访问一个需要认证之后才能访问的接口的时候，Spring Security会使用<code>AuthenticationEntryPoint</code>将用户请求跳转到登录页面，要求用户提供登录凭证。</p>
<p>这里我们也希望系统<code>返回json结果</code>，因此我们定义类<code>实现AuthenticationEntryPoint接口</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取错误信息</span></span><br><span class="line">        <span class="comment">//String localizedMessage = authException.getLocalizedMessage();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建结果对象</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        result.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;需要登录&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换成json字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回响应</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2、SecurityFilterChain配置"><a href="#6-2、SecurityFilterChain配置" class="headerlink" title="6.2、SecurityFilterChain配置"></a>6.2、SecurityFilterChain配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//错误处理</span></span><br><span class="line">http.exceptionHandling(exception  -&gt; &#123;</span><br><span class="line">    exception.authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">MyAuthenticationEntryPoint</span>());<span class="comment">//请求未认证的接口</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="7、跨域"><a href="#7、跨域" class="headerlink" title="7、跨域"></a>7、跨域</h2><p>跨域全称是跨域资源共享(Cross-Origin Resources Sharing,CORS)，它是浏览器的保护机制，只允许网页请求统一域名下的服务，同一域名指&#x3D;&gt;协议、域名、端口号都要保持一致，如果有一项不同，那么就是跨域请求。在前后端分离的项目中，需要解决跨域的问题。</p>
<p>在SpringSecurity中解决跨域很简单，在配置文件中添加如下配置即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//跨域</span></span><br><span class="line">http.cors(withDefaults());</span><br></pre></td></tr></table></figure>



<h1 id="第四章-身份认证"><a href="#第四章-身份认证" class="headerlink" title="第四章 身份认证"></a>第四章 身份认证</h1><h2 id="1、用户认证信息"><a href="#1、用户认证信息" class="headerlink" title="1、用户认证信息"></a>1、用户认证信息</h2><h3 id="1-1、基本概念"><a href="#1-1、基本概念" class="headerlink" title="1.1、基本概念"></a>1.1、基本概念</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/securitycontextholder.png" alt="securitycontextholder"></p>
<p>在Spring Security框架中，SecurityContextHolder、SecurityContext、Authentication、Principal和Credential是一些与身份验证和授权相关的重要概念。它们之间的关系如下：</p>
<ol>
<li>SecurityContextHolder：SecurityContextHolder 是 Spring Security 存储已认证用户详细信息的地方。</li>
<li>SecurityContext：SecurityContext 是从 SecurityContextHolder 获取的内容，包含当前已认证用户的 Authentication 信息。</li>
<li>Authentication：Authentication 表示用户的身份认证信息。它包含了用户的Principal、Credential和Authority信息。</li>
<li>Principal：表示用户的身份标识。它通常是一个表示用户的实体对象，例如用户名。Principal可以通过Authentication对象的getPrincipal()方法获取。</li>
<li>Credentials：表示用户的凭证信息，例如密码、证书或其他认证凭据。Credential可以通过Authentication对象的getCredentials()方法获取。</li>
<li>GrantedAuthority：表示用户被授予的权限</li>
</ol>
<p>总结起来，SecurityContextHolder用于管理当前线程的安全上下文，存储已认证用户的详细信息，其中包含了SecurityContext对象，该对象包含了Authentication对象，后者表示用户的身份验证信息，包括Principal（用户的身份标识）和Credential（用户的凭证信息）。</p>
<h3 id="1-2、在Controller中获取用户信息"><a href="#1-2、在Controller中获取用户信息" class="headerlink" title="1.2、在Controller中获取用户信息"></a>1.2、在Controller中获取用户信息</h3><p>IndexController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;index controller&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.getContext();<span class="comment">//存储认证对象的上下文</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> context.getAuthentication();<span class="comment">//认证对象</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();<span class="comment">//用户名</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span>authentication.getPrincipal();<span class="comment">//身份</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">credentials</span> <span class="operator">=</span> authentication.getCredentials();<span class="comment">//凭证(脱敏)</span></span><br><span class="line">        Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();<span class="comment">//权限</span></span><br><span class="line"></span><br><span class="line">        System.out.println(username);</span><br><span class="line">        System.out.println(principal);</span><br><span class="line">        System.out.println(credentials);</span><br><span class="line">        System.out.println(authorities);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建结果对象</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        result.put(<span class="string">&quot;data&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2、会话并发处理"><a href="#2、会话并发处理" class="headerlink" title="2、会话并发处理"></a>2、会话并发处理</h2><p>后登录的账号会使先登录的账号失效</p>
<h3 id="2-1、实现处理器接口"><a href="#2-1、实现处理器接口" class="headerlink" title="2.1、实现处理器接口"></a>2.1、实现处理器接口</h3><p>实现接口SessionInformationExpiredStrategy</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.securitydemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySessionInformationExpiredStrategy</span> <span class="keyword">implements</span> <span class="title class_">SessionInformationExpiredStrategy</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent event)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建结果对象</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        result.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;该账号已从其他设备登录&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换成json字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">        <span class="comment">//返回响应</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2、SecurityFilterChain配置"><a href="#2-2、SecurityFilterChain配置" class="headerlink" title="2.2、SecurityFilterChain配置"></a>2.2、SecurityFilterChain配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//会话管理</span></span><br><span class="line">http.sessionManagement(session -&gt; &#123;</span><br><span class="line">    session</span><br><span class="line">        .maximumSessions(<span class="number">1</span>)</span><br><span class="line">        .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">MySessionInformationExpiredStrategy</span>());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h1 id="第五章-授权"><a href="#第五章-授权" class="headerlink" title="第五章 授权"></a>第五章 授权</h1><p>授权管理的实现在SpringSecurity中非常灵活，可以帮助应用程序实现以下两种常见的授权需求：</p>
<ul>
<li><p>用户-权限-资源：例如张三的权限是添加用户、查看用户列表，李四的权限是查看用户列表</p>
</li>
<li><p>用户-角色-权限-资源：例如 张三是角色是管理员、李四的角色是普通用户，管理员能做所有操作，普通用户只能查看信息</p>
</li>
</ul>
<h2 id="1、基于request的授权"><a href="#1、基于request的授权" class="headerlink" title="1、基于request的授权"></a>1、基于request的授权</h2><h3 id="1-1、用户-权限-资源"><a href="#1-1、用户-权限-资源" class="headerlink" title="1.1、用户-权限-资源"></a>1.1、用户-权限-资源</h3><p><strong>需求：</strong></p>
<ul>
<li>具有USER_LIST权限的用户可以访问&#x2F;user&#x2F;list接口</li>
<li>具有USER_ADD权限的用户可以访问&#x2F;user&#x2F;add接口</li>
</ul>
<h4 id="配置权限"><a href="#配置权限" class="headerlink" title="配置权限"></a>配置权限</h4><p>SecurityFilterChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启授权保护</span></span><br><span class="line">http.authorizeRequests(</span><br><span class="line">        authorize -&gt; authorize</span><br><span class="line">    			<span class="comment">//具有USER_LIST权限的用户可以访问/user/list</span></span><br><span class="line">                .requestMatchers(<span class="string">&quot;/user/list&quot;</span>).hasAuthority(<span class="string">&quot;USER_LIST&quot;</span>)</span><br><span class="line">    			<span class="comment">//具有USER_ADD权限的用户可以访问/user/add</span></span><br><span class="line">    			.requestMatchers(<span class="string">&quot;/user/add&quot;</span>).hasAuthority(<span class="string">&quot;USER_ADD&quot;</span>)</span><br><span class="line">                <span class="comment">//对所有请求开启授权保护</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">//已认证的请求会被自动授权</span></span><br><span class="line">                .authenticated()</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>

<h4 id="授予权限"><a href="#授予权限" class="headerlink" title="授予权限"></a>授予权限</h4><p>DBUserDetailsManager中的loadUserByUsername方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">authorities.add(()-&gt;<span class="string">&quot;USER_LIST&quot;</span>);</span><br><span class="line">authorities.add(()-&gt;<span class="string">&quot;USER_ADD&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*authorities.add(new GrantedAuthority() &#123;</span></span><br><span class="line"><span class="comment">    @Override</span></span><br><span class="line"><span class="comment">    public String getAuthority() &#123;</span></span><br><span class="line"><span class="comment">        return &quot;USER_LIST&quot;;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;);</span></span><br><span class="line"><span class="comment">authorities.add(new GrantedAuthority() &#123;</span></span><br><span class="line"><span class="comment">    @Override</span></span><br><span class="line"><span class="comment">    public String getAuthority() &#123;</span></span><br><span class="line"><span class="comment">        return &quot;USER_ADD&quot;;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;);*/</span></span><br></pre></td></tr></table></figure>

<h4 id="请求未授权的接口"><a href="#请求未授权的接口" class="headerlink" title="请求未授权的接口"></a>请求未授权的接口</h4><p>SecurityFilterChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//错误处理</span></span><br><span class="line">http.exceptionHandling(exception  -&gt; &#123;</span><br><span class="line">    exception.authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">MyAuthenticationEntryPoint</span>());<span class="comment">//请求未认证的接口</span></span><br><span class="line">    exception.accessDeniedHandler((request, response, e)-&gt;&#123; <span class="comment">//请求未授权的接口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建结果对象</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        result.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换成json字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回响应</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p><strong>更多的例子：</strong><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authorization/authorize-http-requests.html">Authorize HttpServletRequests :: Spring Security</a></p>
<h3 id="1-2、用户-角色-资源"><a href="#1-2、用户-角色-资源" class="headerlink" title="1.2、用户-角色-资源"></a>1.2、用户-角色-资源</h3><p>**需求：**角色为ADMIN的用户才可以访问&#x2F;user&#x2F;**路径下的资源</p>
<h4 id="配置角色"><a href="#配置角色" class="headerlink" title="配置角色"></a>配置角色</h4><p>SecurityFilterChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启授权保护</span></span><br><span class="line">http.authorizeRequests(</span><br><span class="line">        authorize -&gt; authorize</span><br><span class="line">                <span class="comment">//具有管理员角色的用户可以访问/user/**</span></span><br><span class="line">                .requestMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                <span class="comment">//对所有请求开启授权保护</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">//已认证的请求会被自动授权</span></span><br><span class="line">                .authenticated()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="授予角色"><a href="#授予角色" class="headerlink" title="授予角色"></a>授予角色</h4><p>DBUserDetailsManager中的loadUserByUsername方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> org.springframework.security.core.userdetails.User</span><br><span class="line">        .withUsername(user.getUsername())</span><br><span class="line">        .password(user.getPassword())</span><br><span class="line">        .roles(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>



<h3 id="1-3、用户-角色-权限-资源"><a href="#1-3、用户-角色-权限-资源" class="headerlink" title="1.3、用户-角色-权限-资源"></a>1.3、用户-角色-权限-资源</h3><p>RBAC（Role-Based Access Control，基于角色的访问控制）是一种常用的数据库设计方案，它将用户的权限分配和管理与角色相关联。以下是一个基本的RBAC数据库设计方案的示例：</p>
<ol>
<li>用户表（User table）：包含用户的基本信息，例如用户名、密码和其他身份验证信息。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>user_id</td>
<td>int</td>
<td>用户ID</td>
</tr>
<tr>
<td>username</td>
<td>varchar</td>
<td>用户名</td>
</tr>
<tr>
<td>password</td>
<td>varchar</td>
<td>密码</td>
</tr>
<tr>
<td>email</td>
<td>varchar</td>
<td>电子邮件地址</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<ol start="2">
<li>角色表（Role table）：存储所有可能的角色及其描述。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>role_id</td>
<td>int</td>
<td>角色ID</td>
</tr>
<tr>
<td>role_name</td>
<td>varchar</td>
<td>角色名称</td>
</tr>
<tr>
<td>description</td>
<td>varchar</td>
<td>角色描述</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<ol start="3">
<li>权限表（Permission table）：定义系统中所有可能的权限。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>permission_id</td>
<td>int</td>
<td>权限ID</td>
</tr>
<tr>
<td>permission_name</td>
<td>varchar</td>
<td>权限名称</td>
</tr>
<tr>
<td>description</td>
<td>varchar</td>
<td>权限描述</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<ol start="4">
<li>用户角色关联表（User-Role table）：将用户与角色关联起来。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>user_role_id</td>
<td>int</td>
<td>用户角色关联ID</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>用户ID</td>
</tr>
<tr>
<td>role_id</td>
<td>int</td>
<td>角色ID</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<ol start="5">
<li>角色权限关联表（Role-Permission table）：将角色与权限关联起来。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>role_permission_id</td>
<td>int</td>
<td>角色权限关联ID</td>
</tr>
<tr>
<td>role_id</td>
<td>int</td>
<td>角色ID</td>
</tr>
<tr>
<td>permission_id</td>
<td>int</td>
<td>权限ID</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>在这个设计方案中，用户可以被分配一个或多个角色，而每个角色又可以具有一个或多个权限。通过对用户角色关联和角色权限关联表进行操作，可以实现灵活的权限管理和访问控制。</p>
<p>当用户尝试访问系统资源时，系统可以根据用户的角色和权限决定是否允许访问。这样的设计方案使得权限管理更加简单和可维护，因为只需调整角色和权限的分配即可，而不需要针对每个用户进行单独的设置。</p>
<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><p>检查拒绝原因   会在控制台打印拒绝的原因</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">       <span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;当前用户：&quot;</span> + authentication.getName());</span><br><span class="line">           System.out.println(<span class="string">&quot;用户权限：&quot;</span> + authentication.getAuthorities());</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(<span class="string">&quot;拒绝原因：&quot;</span> + accessDeniedException.getMessage());</span><br><span class="line">       response.sendError(HttpServletResponse.SC_FORBIDDEN, <span class="string">&quot;权限不足&quot;</span>);</span><br></pre></td></tr></table></figure>







<h2 id="2、基于方法的授权"><a href="#2、基于方法的授权" class="headerlink" title="2、基于方法的授权"></a>2、基于方法的授权</h2><h3 id="2-1、开启方法授权"><a href="#2-1、开启方法授权" class="headerlink" title="2.1、开启方法授权"></a>2.1、开启方法授权</h3><p>在配置文件中添加如下注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableMethodSecurity</span></span><br></pre></td></tr></table></figure>



<h3 id="2-2、给用户授予角色和权限"><a href="#2-2、给用户授予角色和权限" class="headerlink" title="2.2、给用户授予角色和权限"></a>2.2、给用户授予角色和权限</h3><p>DBUserDetailsManager中的loadUserByUsername方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> org.springframework.security.core.userdetails.User</span><br><span class="line">        .withUsername(user.getUsername())</span><br><span class="line">        .password(user.getPassword())</span><br><span class="line">        .roles(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">        .authorities(<span class="string">&quot;USER_ADD&quot;</span>, <span class="string">&quot;USER_UPDATE&quot;</span>)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>



<h3 id="2-2、常用授权注解"><a href="#2-2、常用授权注解" class="headerlink" title="2.2、常用授权注解"></a>2.2、常用授权注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户必须有 ADMIN 角色 并且 用户名是 admin 才能访问此方法</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) and authentication.name == &#x27;admim&#x27;&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getList</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.list();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户必须有 USER_ADD 权限 才能访问此方法</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;USER_ADD&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">    userService.saveUserDetails(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>更多的例子：</strong><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authorization/method-security.html">Method Security :: Spring Security</a></p>
<h1 id="第六章-OAuth2"><a href="#第六章-OAuth2" class="headerlink" title="第六章 OAuth2"></a>第六章 OAuth2</h1><h2 id="1、OAuth2简介"><a href="#1、OAuth2简介" class="headerlink" title="1、OAuth2简介"></a>1、OAuth2简介</h2><h3 id="1-1、OAuth2是什么"><a href="#1-1、OAuth2是什么" class="headerlink" title="1.1、OAuth2是什么"></a>1.1、OAuth2是什么</h3><p>“Auth” 表示 “授权” Authorization</p>
<p> “O” 是 Open 的简称，表示 “开放”</p>
<p>连在一起就表示 <strong>“开放授权”</strong>，OAuth2是一种开放授权协议。</p>
<p><strong>OAuth2最简向导：</strong><a target="_blank" rel="noopener" href="https://darutk.medium.com/the-simplest-guide-to-oauth-2-0-8c71bd9a15bb">The Simplest Guide To OAuth 2.0</a></p>
<h3 id="1-2、OAuth2的角色"><a href="#1-2、OAuth2的角色" class="headerlink" title="1.2、OAuth2的角色"></a>1.2、OAuth2的角色</h3><p>OAuth 2协议包含以下角色：</p>
<ol>
<li>资源所有者（Resource Owner）：即用户，资源的拥有人，想要通过客户应用访问资源服务器上的资源。</li>
<li>客户应用（Client）：通常是一个Web或者无线应用，它需要访问用户的受保护资源。</li>
<li>资源服务器（Resource Server）：存储受保护资源的服务器或定义了可以访问到资源的API，接收并验证客户端的访问令牌，以决定是否授权访问资源。</li>
<li>授权服务器（Authorization Server）：负责验证资源所有者的身份并向客户端颁发访问令牌。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222124053994.png" alt="image-20231222124053994"></p>
<h3 id="1-3、OAuth2的使用场景"><a href="#1-3、OAuth2的使用场景" class="headerlink" title="1.3、OAuth2的使用场景"></a>1.3、OAuth2的使用场景</h3><h4 id="开放系统间授权"><a href="#开放系统间授权" class="headerlink" title="开放系统间授权"></a>开放系统间授权</h4><h5 id="社交登录"><a href="#社交登录" class="headerlink" title="社交登录"></a>社交登录</h5><p>在传统的身份验证中，用户需要提供用户名和密码，还有很多网站登录时，允许使用第三方网站的身份，这称为”第三方登录”。所谓第三方登录，实质就是 OAuth 授权。用户想要登录 A 网站，A 网站让用户提供第三方网站的数据，证明自己的身份。获取第三方网站的身份数据，就需要 OAuth 授权。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222131233025.png" alt="image-20231222131233025"></p>
<h5 id="开放API"><a href="#开放API" class="headerlink" title="开放API"></a>开放API</h5><p>例如云冲印服务的实现</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222131118611.png" alt="image-20231222131118611"></p>
<h4 id="现代微服务安全"><a href="#现代微服务安全" class="headerlink" title="现代微服务安全"></a>现代微服务安全</h4><h5 id="单块应用安全"><a href="#单块应用安全" class="headerlink" title="单块应用安全"></a>单块应用安全</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222152734546.png" alt="image-20231222152734546"></p>
<h5 id="微服务安全"><a href="#微服务安全" class="headerlink" title="微服务安全"></a>微服务安全</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222152557861.png" alt="image-20231222152557861"></p>
<h4 id="企业内部应用认证授权"><a href="#企业内部应用认证授权" class="headerlink" title="企业内部应用认证授权"></a>企业内部应用认证授权</h4><ul>
<li><p>SSO：Single Sign On 单点登录</p>
</li>
<li><p>IAM：Identity and Access Management 身份识别与访问管理</p>
</li>
</ul>
<h3 id="1-4、OAuth2的四种授权模式"><a href="#1-4、OAuth2的四种授权模式" class="headerlink" title="1.4、OAuth2的四种授权模式"></a>1.4、OAuth2的四种授权模式</h3><p>RFC6749：</p>
<p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6749">RFC 6749 - The OAuth 2.0 Authorization Framework (ietf.org)</a></p>
<p>阮一峰：</p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html">OAuth 2.0 的四种方式 - 阮一峰的网络日志 (ruanyifeng.com)</a></p>
<p>四种模式：</p>
<ul>
<li>授权码（authorization-code）</li>
<li>隐藏式（implicit）</li>
<li>密码式（password）</li>
<li>客户端凭证（client credentials）</li>
</ul>
<h4 id="第一种方式：授权码"><a href="#第一种方式：授权码" class="headerlink" title="第一种方式：授权码"></a>第一种方式：授权码</h4><p><strong>授权码（authorization code），指的是第三方应用先申请一个授权码，然后再用该码获取令牌。</strong></p>
<p>这种方式是最常用，最复杂，也是最安全的，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231220180422742.png" alt="image-20231220180422742"></p>
<ul>
<li>注册客户应用：客户应用如果想要访问资源服务器需要有凭证，需要在授权服务器上注册客户应用。注册后会<strong>获取到一个ClientID和ClientSecrets</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222203153125.png" alt="image-20231222203153125"></p>
<h4 id="第二种方式：隐藏式"><a href="#第二种方式：隐藏式" class="headerlink" title="第二种方式：隐藏式"></a>第二种方式：隐藏式</h4><p><strong>隐藏式（implicit），也叫简化模式，有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。</strong></p>
<p>RFC 6749 规定了这种方式，允许直接向前端颁发令牌。这种方式没有授权码这个中间步骤，所以称为隐藏式。这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p>
<p>​								<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231220185958063.png" alt="image-20231220185958063"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222203218334.png" alt="image-20231222203218334"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://a.com/callback#token=ACCESS_TOKEN</span><br><span class="line">将访问令牌包含在URL锚点中的好处：锚点在HTTP请求中不会发送到服务器，减少了泄漏令牌的风险。</span><br></pre></td></tr></table></figure>





<h4 id="第三种方式：密码式"><a href="#第三种方式：密码式" class="headerlink" title="第三种方式：密码式"></a>第三种方式：密码式</h4><p><strong>密码式（Resource Owner Password Credentials）：如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌。</strong></p>
<p>这种方式需要用户给出自己的用户名&#x2F;密码，显然风险很大，因此只适用于其他授权方式都无法采用的情况，而且必须是用户高度信任的应用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231220190152888.png" alt="image-20231220190152888"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222203240921.png" alt="image-20231222203240921"></p>
<h4 id="第四种方式：凭证式"><a href="#第四种方式：凭证式" class="headerlink" title="第四种方式：凭证式"></a>第四种方式：凭证式</h4><p><strong>凭证式（client credentials）：也叫客户端模式，适用于没有前端的命令行应用，即在命令行下请求令牌。</strong></p>
<p>这种方式给出的令牌，是针对第三方应用的，而不是针对用户的，即有可能多个用户共享同一个令牌。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231220185958063.png" alt="image-20231220185958063"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231222203259785.png" alt="image-20231222203259785"></p>
<h3 id="1-5、授权类型的选择"><a href="#1-5、授权类型的选择" class="headerlink" title="1.5、授权类型的选择"></a>1.5、授权类型的选择</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231223020052999.png" alt="image-20231223020052999"></p>
<h2 id="2、Spring中的OAuth2"><a href="#2、Spring中的OAuth2" class="headerlink" title="2、Spring中的OAuth2"></a>2、Spring中的OAuth2</h2><h3 id="2-1、相关角色"><a href="#2-1、相关角色" class="headerlink" title="2.1、相关角色"></a>2.1、相关角色</h3><p>**回顾：**OAuth 2中的角色</p>
<ol>
<li>资源所有者（Resource Owner）</li>
<li>客户应用（Client）</li>
<li>资源服务器（Resource Server）</li>
<li>授权服务器（Authorization Server）</li>
</ol>
<h3 id="2-2、Spring中的实现"><a href="#2-2、Spring中的实现" class="headerlink" title="2.2、Spring中的实现"></a>2.2、Spring中的实现</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html">OAuth2 :: Spring Security</a></p>
<p><strong>Spring Security</strong></p>
<ul>
<li>客户应用（OAuth2 Client）：OAuth2客户端功能中包含OAuth2 Login</li>
<li>资源服务器（OAuth2 Resource Server）</li>
</ul>
<p><strong>Spring</strong></p>
<ul>
<li>授权服务器（Spring Authorization Server）：它是在Spring Security之上的一个单独的项目。</li>
</ul>
<h3 id="2-3、相关依赖"><a href="#2-3、相关依赖" class="headerlink" title="2.3、相关依赖"></a>2.3、相关依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 资源服务器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 客户应用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 授权服务器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-authorization-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4、授权登录的实现思路"><a href="#2-4、授权登录的实现思路" class="headerlink" title="2.4、授权登录的实现思路"></a>2.4、授权登录的实现思路</h3><p>使用OAuth2 Login</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231223164128030.png" alt="image-20231223164128030"></p>
<h2 id="3、GiuHub社交登录案例"><a href="#3、GiuHub社交登录案例" class="headerlink" title="3、GiuHub社交登录案例"></a>3、GiuHub社交登录案例</h2><h3 id="3-1、创建应用"><a href="#3-1、创建应用" class="headerlink" title="3.1、创建应用"></a>3.1、创建应用</h3><p><strong>注册客户应用：</strong></p>
<p>登录GitHub，在开发者设置中找到OAuth Apps，创建一个application，为客户应用创建访问GitHub的凭据：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20230510154255157.png" alt="image-20230510154255157"></p>
<p>填写应用信息：<code>默认的重定向URI模板为&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;</code>。registrationId是ClientRegistration的唯一标识符。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231221000906168.png" alt="image-20231221000906168"></p>
<p>获取应用程序id，生成应用程序密钥：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20230510163101376.png" alt="image-20230510163101376"></p>
<h3 id="3-2、创建测试项目"><a href="#3-2、创建测试项目" class="headerlink" title="3.2、创建测试项目"></a>3.2、创建测试项目</h3><p>创建一个springboot项目oauth2-login-demo，创建时引入如下依赖</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20230510165314829.png" alt="image-20230510165314829"></p>
<p>示例代码参考：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security-samples/tree/6.2.x/servlet/spring-boot/java/oauth2/login">spring-security-samples&#x2F;servlet&#x2F;spring-boot&#x2F;java&#x2F;oauth2&#x2F;login at 6.2.x · spring-projects&#x2F;spring-security-samples (github.com)</a></p>
<h3 id="3-3、配置OAuth客户端属性"><a href="#3-3、配置OAuth客户端属性" class="headerlink" title="3.3、配置OAuth客户端属性"></a>3.3、配置OAuth客户端属性</h3><p>application.yml：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">security</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">oauth2</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">registration</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">github</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">client-id</span>: <span class="string">7807cc3bb1534abce9f2</span></span><br><span class="line">            <span class="attr">client-secret</span>: <span class="string">008dc141879134433f4db7f62b693c4a5361771b</span></span><br><span class="line"><span class="comment">#            redirectUri: http://localhost:8200/login/oauth2/code/github</span></span><br></pre></td></tr></table></figure>



<h3 id="3-4、创建Controller"><a href="#3-4、创建Controller" class="headerlink" title="3.4、创建Controller"></a>3.4、创建Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.oauthdemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(</span></span><br><span class="line"><span class="params">            Model model,</span></span><br><span class="line"><span class="params">            <span class="meta">@RegisteredOAuth2AuthorizedClient</span> OAuth2AuthorizedClient authorizedClient,</span></span><br><span class="line"><span class="params">            <span class="meta">@AuthenticationPrincipal</span> OAuth2User oauth2User)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;userName&quot;</span>, oauth2User.getName());</span><br><span class="line">        model.addAttribute(<span class="string">&quot;clientName&quot;</span>, authorizedClient.getClientRegistration().getClientName());</span><br><span class="line">        model.addAttribute(<span class="string">&quot;userAttributes&quot;</span>, oauth2User.getAttributes());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-5、创建html页面"><a href="#3-5、创建html页面" class="headerlink" title="3.5、创建html页面"></a>3.5、创建html页面</h3><p>resources&#x2F;templates&#x2F;index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span> <span class="attr">xmlns:sec</span>=<span class="string">&quot;https://www.thymeleaf.org/thymeleaf-extras-springsecurity5&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring Security - OAuth 2.0 Login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span> <span class="attr">th:fragment</span>=<span class="string">&quot;logout&quot;</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;isAuthenticated()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:left&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span>&gt;</span>User: <span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:none&quot;</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:right&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/logout&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Logout&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>OAuth 2.0 Login with Spring Security<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    You are successfully logged in <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;userName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    via the OAuth 2.0 Client <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;clientName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span>&gt;</span>User Attributes:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;userAttribute : $&#123;userAttributes&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;userAttribute.key&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;userAttribute.value&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-6、启动应用程序"><a href="#3-6、启动应用程序" class="headerlink" title="3.6、启动应用程序"></a>3.6、启动应用程序</h3><ul>
<li>启动程序并访问localhost:8080。浏览器将被重定向到默认的自动生成的登录页面，该页面显示了一个用于GitHub登录的链接。</li>
<li>点击GitHub链接，浏览器将被重定向到GitHub进行身份验证。</li>
<li>使用GitHub账户凭据进行身份验证后，用户会看到授权页面，询问用户是否允许或拒绝客户应用访问GitHub上的用户数据。点击允许以授权OAuth客户端访问用户的基本个人资料信息。</li>
<li>此时，OAuth客户端访问GitHub的获取用户信息的接口获取基本个人资料信息，并建立一个已认证的会话。</li>
</ul>
<h2 id="4、案例分析"><a href="#4、案例分析" class="headerlink" title="4、案例分析"></a>4、案例分析</h2><h3 id="4-1、登录流程"><a href="#4-1、登录流程" class="headerlink" title="4.1、登录流程"></a>4.1、登录流程</h3><ol>
<li><strong>A 网站让用户跳转到 GitHub，并携带参数ClientID 以及 Redirection URI。</strong></li>
<li>GitHub 要求用户登录，然后询问用户”A 网站要求获取用户信息的权限，你是否同意？”</li>
<li>用户同意，GitHub 就会重定向回 A 网站，同时发回一个授权码。</li>
<li><strong>A 网站使用授权码，向 GitHub 请求令牌。</strong></li>
<li>GitHub 返回令牌.</li>
<li><strong>A 网站使用令牌，向 GitHub 请求用户数据。</strong></li>
<li>GitHub返回用户数据</li>
<li><strong>A 网站使用 GitHub用户数据登录</strong></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20231223203225688.png" alt="image-20231223203225688"></p>
<h3 id="4-2、CommonOAuth2Provider"><a href="#4-2、CommonOAuth2Provider" class="headerlink" title="4.2、CommonOAuth2Provider"></a>4.2、CommonOAuth2Provider</h3><p>CommonOAuth2Provider是一个预定义的通用OAuth2Provider，为一些知名资源服务API提供商（如Google、GitHub、Facebook）预定义了一组默认的属性。</p>
<p>例如，<strong>授权URI、令牌URI和用户信息URI</strong>通常不经常变化。因此，提供默认值以减少所需的配置。</p>
<p>因此，当我们配置GitHub客户端时，只需要提供client-id和client-secret属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GITHUB &#123;</span><br><span class="line">    <span class="keyword">public</span> ClientRegistration.Builder <span class="title function_">getBuilder</span><span class="params">(String registrationId)</span> &#123;</span><br><span class="line">        ClientRegistration.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="built_in">this</span>.getBuilder(</span><br><span class="line">        registrationId, </span><br><span class="line">        ClientAuthenticationMethod.CLIENT_SECRET_BASIC, </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//授权回调地址(GitHub向客户应用发送回调请求，并携带授权码)   </span></span><br><span class="line">		<span class="string">&quot;&#123;baseUrl&#125;/&#123;action&#125;/oauth2/code/&#123;registrationId&#125;&quot;</span>);</span><br><span class="line">        builder.scope(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;read:user&quot;</span>&#125;);</span><br><span class="line">        <span class="comment">//授权页面</span></span><br><span class="line">        builder.authorizationUri(<span class="string">&quot;https://github.com/login/oauth/authorize&quot;</span>);</span><br><span class="line">        <span class="comment">//客户应用使用授权码，向 GitHub 请求令牌</span></span><br><span class="line">        builder.tokenUri(<span class="string">&quot;https://github.com/login/oauth/access_token&quot;</span>);</span><br><span class="line">        <span class="comment">//客户应用使用令牌向GitHub请求用户数据</span></span><br><span class="line">        builder.userInfoUri(<span class="string">&quot;https://api.github.com/user&quot;</span>);</span><br><span class="line">        <span class="comment">//username属性显示GitHub中获取的哪个属性的信息</span></span><br><span class="line">        builder.userNameAttributeName(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="comment">//登录页面超链接的文本</span></span><br><span class="line">        builder.clientName(<span class="string">&quot;GitHub&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">civets</div><div class="post-copyright__author_desc">生活明朗，万物可爱</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2024/01/24/SpringSecurity%E5%92%8COAuth2/%E7%AC%94%E8%AE%B0/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2024/01/24/SpringSecurity%E5%92%8COAuth2/%E7%AC%94%E8%AE%B0/')">Civets</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2024/01/24/SpringSecurity%E5%92%8COAuth2/%E7%AC%94%E8%AE%B0/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=http://example.com/2024/01/24/SpringSecurity%E5%92%8COAuth2/%E7%AC%94%E8%AE%B0/&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Civets</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/18/study/VUE3/Vue3%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Vue3文档</div></div></a></div><div class="next-post pull-right"><a href="/2024/12/16/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/05_%E6%9F%9C%E6%9C%BA%E7%AE%A1%E7%90%86%E3%80%81%E7%AB%99%E7%82%B9%E7%AE%A1%E7%90%86%E4%B8%8E%E7%9B%91%E6%8E%A7%E7%AE%A1%E7%90%86/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/cbd1fc6ade730.gif" alt="status"/></div></div><div class="author-info__description">狸猫玖玖的小窝.zzz</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">civets</h1><div class="author-info__desc">生活明朗，万物可爱</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/xiaojiu1233" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/572075999" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-Spring-Security%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">1.</span> <span class="toc-text">第一章 Spring Security快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%EF%BC%88authentication%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">1、身份认证（authentication）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E5%88%9B%E5%BB%BASpring-Boot%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1、创建Spring Boot项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E5%88%9B%E5%BB%BAIndexController"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2、创建IndexController</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81%E5%88%9B%E5%BB%BAindex-html"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3、创建index.html</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95Controller"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4、启动项目测试Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E3%80%81%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5、注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1%E3%80%81-logout-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">1.5.1、@{&#x2F;logout}的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2%E3%80%81%E9%A1%B5%E9%9D%A2%E6%A0%B7%E5%BC%8F%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">1.5.2、页面样式无法加载的问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6%E3%80%81Spring-Security%E9%BB%98%E8%AE%A4%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.6、Spring Security默认做了什么</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81Spring-Security-%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">2、Spring Security 的底层原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81Filter"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1、Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81DelegatingFilterProxy"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2、DelegatingFilterProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81FilterChainProxy"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3、FilterChainProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81SecurityFilterChain"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4、SecurityFilterChain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E3%80%81Multiple-SecurityFilterChain"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5、Multiple SecurityFilterChain</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%90%AF%E5%8A%A8%E5%92%8C%E8%BF%90%E8%A1%8C"><span class="toc-number">1.3.</span> <span class="toc-text">3、程序的启动和运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81DefaultSecurityFilterChain"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1、DefaultSecurityFilterChain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81SecurityProperties"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2、SecurityProperties</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-Spring-Security%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">第二章 Spring Security自定义配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">2.1.</span> <span class="toc-text">1、基于内存的用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1、创建自定义配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2、基于内存的用户认证流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.2.</span> <span class="toc-text">2、基于数据库的数据源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81SQL"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1、SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2、引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3、配置数据源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.4、实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E3%80%81Mapper"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.5、Mapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%E3%80%81Service"><span class="toc-number">2.2.6.</span> <span class="toc-text">2.6、Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7%E3%80%81Controller"><span class="toc-number">2.2.7.</span> <span class="toc-text">2.7、Controller</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">2.3.</span> <span class="toc-text">3、基于数据库的用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1、基于数据库的用户认证流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81%E5%AE%9A%E4%B9%89DBUserDetailsManager"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2、定义DBUserDetailsManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96UserDetailsService"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3、初始化UserDetailsService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81SpringSecurity%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.</span> <span class="toc-text">4、SpringSecurity的默认配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-number">2.5.</span> <span class="toc-text">5、添加用户功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1%E3%80%81Controller"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1、Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%E3%80%81Service"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2、Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3%E3%80%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.3.</span> <span class="toc-text">5.3、修改配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4%E3%80%81%E4%BD%BF%E7%94%A8Swagger%E6%B5%8B%E8%AF%95"><span class="toc-number">2.5.4.</span> <span class="toc-text">5.4、使用Swagger测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5%E3%80%81%E5%85%B3%E9%97%ADcsrf%E6%94%BB%E5%87%BB%E9%98%B2%E5%BE%A1"><span class="toc-number">2.5.5.</span> <span class="toc-text">5.5、关闭csrf攻击防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">2.6.</span> <span class="toc-text">6、密码加密算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%E3%80%81%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F"><span class="toc-number">2.6.1.</span> <span class="toc-text">6.1、密码加密方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%E3%80%81PasswordEncoder"><span class="toc-number">2.6.2.</span> <span class="toc-text">6.2、PasswordEncoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3%E3%80%81%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%B5%8B%E8%AF%95"><span class="toc-number">2.6.3.</span> <span class="toc-text">6.3、密码加密测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4%E3%80%81DelegatingPasswordEncoder"><span class="toc-number">2.6.4.</span> <span class="toc-text">6.4、DelegatingPasswordEncoder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.7.</span> <span class="toc-text">7、自定义登录页面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1%E3%80%81%E5%88%9B%E5%BB%BA%E7%99%BB%E5%BD%95Controller"><span class="toc-number">2.7.1.</span> <span class="toc-text">7.1、创建登录Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2%E3%80%81%E5%88%9B%E5%BB%BA%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.7.2.</span> <span class="toc-text">7.2、创建登录页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3%E3%80%81%E9%85%8D%E7%BD%AESecurityFilterChain"><span class="toc-number">2.7.3.</span> <span class="toc-text">7.3、配置SecurityFilterChain</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB"><span class="toc-number">3.</span> <span class="toc-text">第三章 前后端分离</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">1、用户认证流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%BC%95%E5%85%A5fastjson"><span class="toc-number">3.2.</span> <span class="toc-text">2、引入fastjson</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E7%9A%84%E5%93%8D%E5%BA%94"><span class="toc-number">3.3.</span> <span class="toc-text">3、认证成功的响应</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E6%88%90%E5%8A%9F%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1、成功结果处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81SecurityFilterChain%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2、SecurityFilterChain配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E5%93%8D%E5%BA%94"><span class="toc-number">3.4.</span> <span class="toc-text">4、认证失败响应</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E3%80%81%E5%A4%B1%E8%B4%A5%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">3.4.1.</span> <span class="toc-text">4.1、失败结果处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2SecurityFilterChain%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.2.</span> <span class="toc-text">4.2SecurityFilterChain配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%B3%A8%E9%94%80%E5%93%8D%E5%BA%94"><span class="toc-number">3.5.</span> <span class="toc-text">5、注销响应</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1%E3%80%81%E6%B3%A8%E9%94%80%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">3.5.1.</span> <span class="toc-text">5.1、注销结果处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%E3%80%81SecurityFilterChain%E9%85%8D%E7%BD%AE"><span class="toc-number">3.5.2.</span> <span class="toc-text">5.2、SecurityFilterChain配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E8%AF%B7%E6%B1%82%E6%9C%AA%E8%AE%A4%E8%AF%81%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.6.</span> <span class="toc-text">6、请求未认证的接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%E3%80%81%E5%AE%9E%E7%8E%B0AuthenticationEntryPoint%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.6.1.</span> <span class="toc-text">6.1、实现AuthenticationEntryPoint接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%E3%80%81SecurityFilterChain%E9%85%8D%E7%BD%AE"><span class="toc-number">3.6.2.</span> <span class="toc-text">6.2、SecurityFilterChain配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E8%B7%A8%E5%9F%9F"><span class="toc-number">3.7.</span> <span class="toc-text">7、跨域</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">4.</span> <span class="toc-text">第四章 身份认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.</span> <span class="toc-text">1、用户认证信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.1.</span> <span class="toc-text">1.1、基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E5%9C%A8Controller%E4%B8%AD%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.2.</span> <span class="toc-text">1.2、在Controller中获取用户信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BC%9A%E8%AF%9D%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">2、会话并发处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E5%AE%9E%E7%8E%B0%E5%A4%84%E7%90%86%E5%99%A8%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.1.</span> <span class="toc-text">2.1、实现处理器接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81SecurityFilterChain%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.2、SecurityFilterChain配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-%E6%8E%88%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">第五章 授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%9F%BA%E4%BA%8Erequest%E7%9A%84%E6%8E%88%E6%9D%83"><span class="toc-number">5.1.</span> <span class="toc-text">1、基于request的授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E7%94%A8%E6%88%B7-%E6%9D%83%E9%99%90-%E8%B5%84%E6%BA%90"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1、用户-权限-资源</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9D%83%E9%99%90"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">配置权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E4%BA%88%E6%9D%83%E9%99%90"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">授予权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%9C%AA%E6%8E%88%E6%9D%83%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">请求未授权的接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E7%94%A8%E6%88%B7-%E8%A7%92%E8%89%B2-%E8%B5%84%E6%BA%90"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.2、用户-角色-资源</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%A7%92%E8%89%B2"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">配置角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E4%BA%88%E8%A7%92%E8%89%B2"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">授予角色</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81%E7%94%A8%E6%88%B7-%E8%A7%92%E8%89%B2-%E6%9D%83%E9%99%90-%E8%B5%84%E6%BA%90"><span class="toc-number">5.1.3.</span> <span class="toc-text">1.3、用户-角色-权限-资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">6.</span> <span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%9F%BA%E4%BA%8E%E6%96%B9%E6%B3%95%E7%9A%84%E6%8E%88%E6%9D%83"><span class="toc-number">6.1.</span> <span class="toc-text">2、基于方法的授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E5%BC%80%E5%90%AF%E6%96%B9%E6%B3%95%E6%8E%88%E6%9D%83"><span class="toc-number">6.1.1.</span> <span class="toc-text">2.1、开启方法授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E7%BB%99%E7%94%A8%E6%88%B7%E6%8E%88%E4%BA%88%E8%A7%92%E8%89%B2%E5%92%8C%E6%9D%83%E9%99%90"><span class="toc-number">6.1.2.</span> <span class="toc-text">2.2、给用户授予角色和权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E5%B8%B8%E7%94%A8%E6%8E%88%E6%9D%83%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.1.3.</span> <span class="toc-text">2.2、常用授权注解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-OAuth2"><span class="toc-number">7.</span> <span class="toc-text">第六章 OAuth2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81OAuth2%E7%AE%80%E4%BB%8B"><span class="toc-number">7.1.</span> <span class="toc-text">1、OAuth2简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81OAuth2%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.1、OAuth2是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81OAuth2%E7%9A%84%E8%A7%92%E8%89%B2"><span class="toc-number">7.1.2.</span> <span class="toc-text">1.2、OAuth2的角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81OAuth2%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">7.1.3.</span> <span class="toc-text">1.3、OAuth2的使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%94%BE%E7%B3%BB%E7%BB%9F%E9%97%B4%E6%8E%88%E6%9D%83"><span class="toc-number">7.1.3.1.</span> <span class="toc-text">开放系统间授权</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95"><span class="toc-number">7.1.3.1.1.</span> <span class="toc-text">社交登录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%94%BEAPI"><span class="toc-number">7.1.3.1.2.</span> <span class="toc-text">开放API</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%B0%E4%BB%A3%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8"><span class="toc-number">7.1.3.2.</span> <span class="toc-text">现代微服务安全</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E5%9D%97%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8"><span class="toc-number">7.1.3.2.1.</span> <span class="toc-text">单块应用安全</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8"><span class="toc-number">7.1.3.2.2.</span> <span class="toc-text">微服务安全</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E5%86%85%E9%83%A8%E5%BA%94%E7%94%A8%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83"><span class="toc-number">7.1.3.3.</span> <span class="toc-text">企业内部应用认证授权</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81OAuth2%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.1.4.</span> <span class="toc-text">1.4、OAuth2的四种授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%E6%8E%88%E6%9D%83%E7%A0%81"><span class="toc-number">7.1.4.1.</span> <span class="toc-text">第一种方式：授权码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%E9%9A%90%E8%97%8F%E5%BC%8F"><span class="toc-number">7.1.4.2.</span> <span class="toc-text">第二种方式：隐藏式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%E5%AF%86%E7%A0%81%E5%BC%8F"><span class="toc-number">7.1.4.3.</span> <span class="toc-text">第三种方式：密码式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%E5%87%AD%E8%AF%81%E5%BC%8F"><span class="toc-number">7.1.4.4.</span> <span class="toc-text">第四种方式：凭证式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E3%80%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">7.1.5.</span> <span class="toc-text">1.5、授权类型的选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81Spring%E4%B8%AD%E7%9A%84OAuth2"><span class="toc-number">7.2.</span> <span class="toc-text">2、Spring中的OAuth2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E7%9B%B8%E5%85%B3%E8%A7%92%E8%89%B2"><span class="toc-number">7.2.1.</span> <span class="toc-text">2.1、相关角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81Spring%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.2.</span> <span class="toc-text">2.2、Spring中的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-number">7.2.3.</span> <span class="toc-text">2.3、相关依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81%E6%8E%88%E6%9D%83%E7%99%BB%E5%BD%95%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">7.2.4.</span> <span class="toc-text">2.4、授权登录的实现思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81GiuHub%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95%E6%A1%88%E4%BE%8B"><span class="toc-number">7.3.</span> <span class="toc-text">3、GiuHub社交登录案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8"><span class="toc-number">7.3.1.</span> <span class="toc-text">3.1、创建应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E9%A1%B9%E7%9B%AE"><span class="toc-number">7.3.2.</span> <span class="toc-text">3.2、创建测试项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%E3%80%81%E9%85%8D%E7%BD%AEOAuth%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B1%9E%E6%80%A7"><span class="toc-number">7.3.3.</span> <span class="toc-text">3.3、配置OAuth客户端属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%E3%80%81%E5%88%9B%E5%BB%BAController"><span class="toc-number">7.3.4.</span> <span class="toc-text">3.4、创建Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5%E3%80%81%E5%88%9B%E5%BB%BAhtml%E9%A1%B5%E9%9D%A2"><span class="toc-number">7.3.5.</span> <span class="toc-text">3.5、创建html页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6%E3%80%81%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">7.3.6.</span> <span class="toc-text">3.6、启动应用程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">7.4.</span> <span class="toc-text">4、案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E3%80%81%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-number">7.4.1.</span> <span class="toc-text">4.1、登录流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E3%80%81CommonOAuth2Provider"><span class="toc-number">7.4.2.</span> <span class="toc-text">4.2、CommonOAuth2Provider</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/02/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" title="无题">无题</a><time datetime="2025-04-02T00:35:45.693Z" title="发表于 2025-04-02 08:35:45">2025-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/01/Docker/" title="Docker万物">Docker万物</a><time datetime="2025-04-01T03:40:15.283Z" title="发表于 2025-04-01 11:40:15">2025-04-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/31/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="多线程">多线程</a><time datetime="2025-03-31T01:03:23.952Z" title="发表于 2025-03-31 09:03:23">2025-03-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/29/ELK/" title="ELK学习">ELK学习</a><time datetime="2025-03-29T14:21:46.266Z" title="发表于 2025-03-29 22:21:46">2025-03-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/29/%E8%BF%99%E9%87%8C%E6%98%AF%E4%B8%80%E4%BB%BD%E5%AE%8C%E6%95%B4%E7%9A%84%20Java%20%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF%EF%BC%8C%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E9%AB%98%E7%BA%A7%EF%BC%8C%E6%B6%B5%E7%9B%96%20Java%20%E6%A0%B8%E5%BF%83%E3%80%81Web%20%E5%BC%80%E5%8F%91%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E7%AD%89%EF%BC%8C%E9%80%82%E5%90%88%E6%83%B3%E8%A6%81%E6%B7%B1%E5%85%A5%E6%8E%8C%E6%8F%A1%20Java%20%E5%B9%B6%E5%BA%94%E7%94%A8%E5%88%B0%20%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%A1%B9%E7%9B%AE%20%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%80%85%E3%80%82/" title="分页">分页</a><time datetime="2025-03-29T08:13:24.006Z" title="发表于 2025-03-29 16:13:24">2025-03-29</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="civets" target="_blank">civets</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://fn-civets.s.odn.cc" title="CivetsNas"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="CivetsNas"/><span class="back-menu-item-text">CivetsNas</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("22/03/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 civets 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>