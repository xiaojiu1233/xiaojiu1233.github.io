<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Civets | Civets</title><meta name="author" content="civets"><meta name="copyright" content="civets"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Civets"><meta name="application-name" content="Civets"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Civets"><meta property="og:url" content="http://example.com/2025/02/27/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/11_RabbitMQ/index.html"><meta property="og:site_name" content="Civets"><meta property="og:description" content="RabbitMQ[TOC] 1、消息队列解决什么问题消息队列都解决了什么问题？ 1.1、异步  1.2、解耦​	 1.3、并行  1.4、排队  2、MQ整合2.1、使用场景以尚品甄选为例：如果用户登录成功，我们需要保存登录日志、登录成功给用户发送短信通知、下单成功需要清空购物车中选中的购物项等等可"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg"><meta property="article:author" content="civets"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg"><meta name="description" content="RabbitMQ[TOC] 1、消息队列解决什么问题消息队列都解决了什么问题？ 1.1、异步  1.2、解耦​	 1.3、并行  1.4、排队  2、MQ整合2.1、使用场景以尚品甄选为例：如果用户登录成功，我们需要保存登录日志、登录成功给用户发送短信通知、下单成功需要清空购物车中选中的购物项等等可"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/02/27/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/11_RabbitMQ/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: civets","link":"链接: ","source":"来源: Civets","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Civets',
  title: 'Civets',
  postAI: '',
  pageFillDescription: 'RabbitMQ, 1、消息队列解决什么问题, 1.1、异步, 1.2、解耦, 1.3、并行, 1.4、排队, 2、MQ整合, 2.1、使用场景, 2.2、访问RabbitMQ, 3、RabbitMQ模块搭建, 3.1、搭建share-common-rabbit模块, 3.1.1、新建模块, 3.1.2、pom.xml, 3.1.3、RabbitService, 3.1.4、加载配置类, 3.1.5、MqConst, 3.2、  RabbitMQ测试, 3.2.1、配置RabbitMQ, 3.2.2、引入share-common-rabbit模块, 3.2.3、MqController, 3.2.4、TestReceiver, 3.2.5、knife4j测试, 3.3、消息可靠性配置, 3.3.1、介绍, 3.3.2、消息发送确认配置, 1、封装发送端消息确认配置类, 2、加载配置类, 3、修改配置, 4、MqController, 5、TestReceiver, 3.3.3、消息发送失败设置重发机制, 1、GmallCorrelationData, 2、RabbitService, 3、RabbitInitConfigApplicationListener, 3.4、延迟消息, 3.4.1、基于死信实现延迟消息, 1、消息的TTL（Time To Live）, 2、死信交换机  Dead Letter Exchanges, 3、代码实现, DeadLetterMqConfig, MqController, TestReceiver, 3.4.2、基于延迟插件实现延迟消息, 1、插件安装, 2、代码实现, DelayedMqConfig, MqController, RabbitService, MQProducerAckConfig, 3、消费者端幂等性处理, 3.4.3、基于延迟插件实现解锁卡槽, 1、需求说明, 2、pom.xml, 3、发送延迟消息, 3、DeviceReceiver, 4、IDeviceService, 5、DeviceServiceI, 4、创建订单, 4.1、发送消息, 4.1.1、PowerBankUnlockHandler, 4.1.2、SubmitOrderVo, 4.2、接收消息, 4.2.1、OrderReceiver, 4.2.2、IOrderInfoService, 4.2.2、OrderInfoServiceI消息队列解决什么问题消息队列都解决了什么问题异步解耦并行排队整合使用场景以尚品甄选为例如果用户登录成功我们需要保存登录日志登录成功给用户发送短信通知下单成功需要清空购物车中选中的购物项等等可能都需要远程调用才能实现如果使用就可以实现异步解耦合访问第一天已安装访问地址用户名密码模块搭建搭建模块由于消息队列是公共模块我们把的相关代码生产者封装到该模块其他微服务模块都可能使用因此我们把他封装到一个单独的模块需要使用的模块直接引用该模块即可新建模块在模块下新建模块服务消息队列缓存服务发送消息交换机路由键消息加载配置类提供常量类测试队列订单队列支付解锁卡槽延迟消息测试我们在模块测试消息配置在配置中心文件添加配置说明改为实际的引入模块在模块文件添加依赖发送消息接口管理发送消息监听消息监听消息都可以接收消息接收消息测试发送消息监听消息查看打印结果消息可靠性配置介绍消息的可靠性一般需要三个方面一起保证生产者不丢数据服务器不丢数据消费者不丢数据保证消息不丢失有两种实现方式开启事务模式消息息确认模式生产者消费者说明开启事务会大幅降低消息发送及接收效率使用的相对较少因此我们生产环境一般都采取消息确认模式以下我们只是讲解消息确认模式消息发送确认配置消息发送确认可以保证生产者不丢数据封装发送端消息确认配置类操作模块只确认消息是否正确到达中成功与否都会回调相关数据非消息本身业务数据应答结果如果发送消息到交换器失败错误原因消息到交换器成功消息发送到成功消息到交换器失败消息发送到失败消息没有正确到达队列时触发回调如果正确到达队列不执行加载配置类修改配置在配置中心修改配置默认情况下消息消费者是自动确认消息的如果要手动确认消息则需要修改确认模式为消费者每次从队列获取的消息数量此属性当不设置时为轮询分发设置为为公平分发发送确认消息发送确认消息监听确认消息监听确认消息接收确认消息确认一个消息批量确认消息发送失败设置重发机制实现思路借助来实现重发机制操作模块自定义一个实体类来接收消息消息体交换机路由键重试次数是否延迟消息延迟时长修改发送方法发送消息交换机路由键消息创建自定义相关消息对象包含业务数据本身交换器名称路由键队列类型延迟时间重试次数将相关消息封装到发送消息方法中将相关消息存入相关消息对象分钟修改类只确认消息是否正确到达中成功与否都会回调相关数据非消息本身业务数据应答结果如果发送消息到交换器失败错误原因消息到交换器成功消息发送到成功消息到交换器失败消息发送到失败执行消息重发消息没有正确到达队列时触发回调如果正确到达队列不执行当路由队列失败也需要重发构建相关数据对象调用消息重发方法消息重新发送获取相关数据获取中存放重试次数先重发在写会到中次数超过最大重试次数生产者超过最大重试次数将失败的消息存入数据库用人工处理给管理员发送邮件给管理员发送短信重发消息重发次数进行消息重发延迟消息延迟消息有两种实现方案基于死信队列集成延迟插件基于死信实现延迟消息使用来实现延迟消息必须先了解的两个概念消息的和死信通过这两者的组合来实现延迟队列消息的消息的就是消息的存活时间可以对队列和消息分别设置对队列设置就是队列没有消费者连着的保留时间也可以对每一个单独的消息做单独的设置超过了这个时间我们认为这个消息就死了称之为死信如何设置我们创建一个队列在中添加为单位是毫秒那所在压在这个队列的消息在秒后会消失死信交换机一个消息在满足如下条件下会进死信路由记住这里是路由而不是队列一个路由可以对应很多队列一个消息被拒收了并且方法的参数里是也就是说不会被再次放在队列里被其他消费者使用上面的消息的到了消息过期了队列的长度限制满了排在前面的消息会被丢弃或者扔到死信路由上其实就是一种普通的和创建其他没有两样只是在某一个设置的队列中有消息过期了会自动触发消息的转发发送到中去我们现在可以测试一下延迟队列创建死信队列创建交换机建立交换器与队列之间的绑定创建队列代码实现操作模块声明一些变量定义交换机设置如果队列一出现问题则通过参数转到上参数绑定此处的固定值不能随意写设置延迟时间队列名称是否持久化是否独享排外的只可以在本次连接中访问是否自动删除队列的其他属性参数将队列一通过绑定到交换机上这个队列二就是一个普通队列设置队列二的绑定规则将队列二通过绑定到交换机上消息发送延迟消息基于死信实现发送延迟消息基于死信实现我是延迟消息接收消息监听延迟消息死信消费者基于延迟插件实现延迟消息实现了一个插件来实现延时队列插件安装已安装代码实现操作模块第一个参数是创建的的名字第二个参数是是否支持持久化发送延迟消息基于延迟插件调用工具方法发送延迟消息我是延迟消息封装到工具类模块操作模块发送延迟消息方法交换机路由键消息数据延迟时间单位为秒创建自定义相关消息对象包含业务数据本身交换器名称路由键队列类型延迟时间重试次数将相关消息封装到发送消息方法中将相关消息存入相关消息对象分钟队列确认增加延迟消息判断操作模块只确认消息是否正确到达中成功与否都会回调相关数据非消息本身业务数据应答结果如果发送消息到交换器失败错误原因消息没有正确到达队列时触发回调如果正确到达队列不执行方式一如果不考虑延迟消息重发直接返回调用消息重发方法消息重新发送获取相关数据获取中存放重试次数先重发在写会到中次数超过最大重试次数生产者超过最大重试次数将失败的消息存入数据库用人工处理给管理员发送邮件给管理员发送短信重发次数进行消息重发重发消息方式二如果是延迟消息依然需要设置消息延迟时间延迟消息普通消息消费者端幂等性处理消费结果会发送多次也被消费多次如何保证消息幂等性使用数据库方式使用命令解决推荐监听延迟消息接收消息消费者端判断是否需要做幂等性处理如果业务保证幂等性基于保证说明该业务数据以及被执行执行业务基于延迟插件实现解锁卡槽需求说明如果我们扫码柜机充电宝服务器已经成功获取充电宝相关信息发送消息给柜机了但是由于柜机原因不能弹出及时充电宝因此我们要解锁卡槽对应的充电宝操作模块发送延迟消息扫码后未弹出充电宝等情况延迟解锁设备服务解锁充电宝卡槽消息防止重复请求重复请求手动应答设备服务解锁充电宝卡槽失败消费异常重新入队状态占用空闲锁定创建订单前面完成了充电宝弹出相关业务创建订单是通过消息因此完成该功能发送消息完善发送创建订单消息构建订单对象构建订单对象发送信息该实体放到模块消息编号用户送货地址充电宝编号借用站点借用站点借用地点名称借用地点名称借用柜机编号借用柜机编号费用规则接收消息订单服务租借充电宝消息防止重复请求重复请求手动应答订单服务订单归还失败订单编号消费异常重新入队费用规则用户昵称',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-02-27 20:32:44',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://fn-civets.s.odn.cc" title="CivetsNas"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="CivetsNas"/><span class="back-menu-item-text">CivetsNas</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Civets</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">23</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-02-27T12:32:44.000Z" title="发表于 2025-02-27 20:32:44">2025-02-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-02-27T12:32:44.000Z" title="更新于 2025-02-27 20:32:44">2025-02-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/02/27/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/11_RabbitMQ/"><header><h1 id="CrawlerTitle" itemprop="name headline">无题</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">civets</span><time itemprop="dateCreated datePublished" datetime="2025-02-27T12:32:44.000Z" title="发表于 2025-02-27 20:32:44">2025-02-27</time><time itemprop="dateCreated datePublished" datetime="2025-02-27T12:32:44.000Z" title="更新于 2025-02-27 20:32:44">2025-02-27</time></header><h1 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h1><p>[TOC]</p>
<h2 id="1、消息队列解决什么问题"><a href="#1、消息队列解决什么问题" class="headerlink" title="1、消息队列解决什么问题"></a>1、消息队列解决什么问题</h2><p>消息队列都解决了什么问题？</p>
<h3 id="1-1、异步"><a href="#1-1、异步" class="headerlink" title="1.1、异步"></a>1.1、异步</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/wps151.jpg" alt="img"> </p>
<h3 id="1-2、解耦"><a href="#1-2、解耦" class="headerlink" title="1.2、解耦"></a>1.2、解耦</h3><p>​	<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/wps152.jpg" alt="img"></p>
<h3 id="1-3、并行"><a href="#1-3、并行" class="headerlink" title="1.3、并行"></a>1.3、并行</h3><p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/wps153.jpg" alt="img"></p>
<h3 id="1-4、排队"><a href="#1-4、排队" class="headerlink" title="1.4、排队"></a>1.4、排队</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/wps154.jpg" alt="img"> </p>
<h2 id="2、MQ整合"><a href="#2、MQ整合" class="headerlink" title="2、MQ整合"></a>2、MQ整合</h2><h3 id="2-1、使用场景"><a href="#2-1、使用场景" class="headerlink" title="2.1、使用场景"></a>2.1、使用场景</h3><p>以尚品甄选为例：如果用户登录成功，我们需要保存登录日志、登录成功给用户发送短信通知、下单成功需要清空购物车中选中的购物项等等可能都需要远程调用才能实现，如果使用MQ就可以实现异步解耦合。</p>
<h3 id="2-2、访问RabbitMQ"><a href="#2-2、访问RabbitMQ" class="headerlink" title="2.2、访问RabbitMQ"></a>2.2、访问RabbitMQ</h3><p>第一天已安装</p>
<p>访问IP地址：<a target="_blank" rel="noopener" href="http://ip:15672/">http://ip:15672</a></p>
<ul>
<li>用户名：guest</li>
<li>密码：guest</li>
</ul>
<h2 id="3、RabbitMQ模块搭建"><a href="#3、RabbitMQ模块搭建" class="headerlink" title="3、RabbitMQ模块搭建"></a>3、RabbitMQ模块搭建</h2><h3 id="3-1、搭建share-common-rabbit模块"><a href="#3-1、搭建share-common-rabbit模块" class="headerlink" title="3.1、搭建share-common-rabbit模块"></a>3.1、搭建share-common-rabbit模块</h3><p>由于消息队列是公共模块，我们把mq的相关代码（生产者）封装到该模块，其他service微服务模块都可能使用，因此我们把他封装到一个单独的模块，需要使用mq的模块直接引用该模块即可</p>
<h4 id="3-1-1、新建模块"><a href="#3-1-1、新建模块" class="headerlink" title="3.1.1、新建模块"></a>3.1.1、新建模块</h4><p>在<code>share-common</code>模块下新建<code>share-common-rabbit</code>模块</p>
<h4 id="3-1-2、pom-xml"><a href="#3-1-2、pom-xml" class="headerlink" title="3.1.2、pom.xml"></a>3.1.2、pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.share<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>share-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>share-common-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">        share-common-rabbit服务</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--rabbitmq消息队列--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 缓存服务 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.share<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>share-common-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-1-3、RabbitService"><a href="#3-1-3、RabbitService" class="headerlink" title="3.1.3、RabbitService"></a>3.1.3、RabbitService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.common.rabbit.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange   交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message    消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingKey, Object message)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-4、加载配置类"><a href="#3-1-4、加载配置类" class="headerlink" title="3.1.4、加载配置类"></a>3.1.4、加载配置类</h4><p>resources&#x2F;META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.share.common.rabbit.service.RabbitService</span><br></pre></td></tr></table></figure>

<h4 id="3-1-5、MqConst"><a href="#3-1-5、MqConst" class="headerlink" title="3.1.5、MqConst"></a>3.1.5、MqConst</h4><p>提供常量类 MqConst</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.common.rabbit.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConst</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_TEST</span> <span class="operator">=</span> <span class="string">&quot;share.test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_TEST</span> <span class="operator">=</span> <span class="string">&quot;share.test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_CONFIRM</span> <span class="operator">=</span> <span class="string">&quot;share.confirm&quot;</span>;</span><br><span class="line">    <span class="comment">//队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_TEST</span>  <span class="operator">=</span> <span class="string">&quot;share.test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_CONFIRM</span>  <span class="operator">=</span> <span class="string">&quot;share.confirm&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_ORDER</span> <span class="operator">=</span> <span class="string">&quot;share.order&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_SUBMIT_ORDER</span> <span class="operator">=</span> <span class="string">&quot;share.submit.order&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_END_ORDER</span> <span class="operator">=</span> <span class="string">&quot;share.end.order&quot;</span>;</span><br><span class="line">    <span class="comment">//队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_SUBMIT_ORDER</span> <span class="operator">=</span> <span class="string">&quot;share.submit.order&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_END_ORDER</span> <span class="operator">=</span> <span class="string">&quot;share.end.order&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_PAYMENT_PAY</span> <span class="operator">=</span> <span class="string">&quot;share.payment&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_PAYMENT_PAY</span> <span class="operator">=</span> <span class="string">&quot;share.payment.pay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_PAYMENT_PAY</span> <span class="operator">=</span> <span class="string">&quot;share.payment.pay&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解锁卡槽延迟消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DEVICE</span> <span class="operator">=</span> <span class="string">&quot;share.device&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_UNLOCK_SLOT</span> <span class="operator">=</span> <span class="string">&quot;share.unlock.slot&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_UNLOCK_SLOT</span> <span class="operator">=</span> <span class="string">&quot;share.unlock.slot&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">CANCEL_UNLOCK_SLOT_DELAY_TIME</span> <span class="operator">=</span> <span class="number">1</span> * <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2、-RabbitMQ测试"><a href="#3-2、-RabbitMQ测试" class="headerlink" title="3.2、  RabbitMQ测试"></a>3.2、  RabbitMQ测试</h3><p>我们在<code>share-order</code>模块测试mq消息</p>
<h4 id="3-2-1、配置RabbitMQ"><a href="#3-2-1、配置RabbitMQ" class="headerlink" title="3.2.1、配置RabbitMQ"></a>3.2.1、配置RabbitMQ</h4><p>在nacos配置中心，share-order-dev.yml文件添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>

<p>说明：host改为实际的IP</p>
<h4 id="3-2-2、引入share-common-rabbit模块"><a href="#3-2-2、引入share-common-rabbit模块" class="headerlink" title="3.2.2、引入share-common-rabbit模块"></a>3.2.2、引入share-common-rabbit模块</h4><p>在<code>share-order</code>模块pom.xml文件添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.share<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>share-common-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-2-3、MqController"><a href="#3-2-3、MqController" class="headerlink" title="3.2.3、MqController"></a>3.2.3、MqController</h4><p> 发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Tag(name = &quot;Mq接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/mq&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqController</span> <span class="keyword">extends</span> <span class="title class_">BaseController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;发送消息&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sendMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">sendMessage</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        rabbitService.sendMessage(MqConst.EXCHANGE_TEST, MqConst.ROUTING_TEST, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4、TestReceiver"><a href="#3-2-4、TestReceiver" class="headerlink" title="3.2.4、TestReceiver"></a>3.2.4、TestReceiver</h4><p>监听消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.order.receiver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestReceiver</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = MqConst.EXCHANGE_TEST, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            value = @Queue(value = MqConst.QUEUE_TEST, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            key = MqConst.ROUTING_TEST</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(String content, Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//都可以</span></span><br><span class="line">        log.info(<span class="string">&quot;接收消息：&#123;&#125;&quot;</span>, content);</span><br><span class="line">        log.info(<span class="string">&quot;接收消息：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-5、knife4j测试"><a href="#3-2-5、knife4j测试" class="headerlink" title="3.2.5、knife4j测试"></a>3.2.5、knife4j测试</h4><p>发送消息</p>
<p>监听消息：查看idea打印结果</p>
<h3 id="3-3、消息可靠性配置"><a href="#3-3、消息可靠性配置" class="headerlink" title="3.3、消息可靠性配置"></a>3.3、消息可靠性配置</h3><h4 id="3-3-1、介绍"><a href="#3-3-1、介绍" class="headerlink" title="3.3.1、介绍"></a>3.3.1、介绍</h4><p>MQ消息的可靠性，一般需要三个方面一起保证：</p>
<ol>
<li>生产者不丢数据</li>
<li>MQ服务器不丢数据</li>
<li>消费者不丢数据</li>
</ol>
<p>保证消息不丢失有两种实现方式：</p>
<ul>
<li>开启事务模式</li>
<li>消息息确认模式（生产者，消费者）</li>
</ul>
<p>**说明：**开启事务会大幅降低消息发送及接收效率，使用的相对较少，因此我们生产环境一般都采取消息确认模式，以下我们只是讲解消息确认模式</p>
<h4 id="3-3-2、消息发送确认配置"><a href="#3-3-2、消息发送确认配置" class="headerlink" title="3.3.2、消息发送确认配置"></a>3.3.2、消息发送确认配置</h4><p>消息发送确认可以保证生产者不丢数据</p>
<h5 id="1、封装发送端消息确认配置类"><a href="#1、封装发送端消息确认配置类" class="headerlink" title="1、封装发送端消息确认配置类"></a>1、封装发送端消息确认配置类</h5><p>操作模块：<code>share-common-rabbit</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.common.rabbit.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitInitConfigApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setupCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupCallbacks</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> correlation 相关数据  非消息本身业务数据</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ack             应答结果</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> reason           如果发送消息到交换器失败，错误原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback((correlationData, ack, reason) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">                <span class="comment">//消息到交换器成功</span></span><br><span class="line">                log.info(<span class="string">&quot;消息发送到Exchange成功：&#123;&#125;&quot;</span>, correlationData);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//消息到交换器失败</span></span><br><span class="line">                log.error(<span class="string">&quot;消息发送到Exchange失败：&#123;&#125;&quot;</span>, reason);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Returned: &quot;</span> + returned.getMessage() + <span class="string">&quot;\nreplyCode: &quot;</span> + returned.getReplyCode()</span><br><span class="line">                    + <span class="string">&quot;\nreplyText: &quot;</span> + returned.getReplyText() + <span class="string">&quot;\nexchange/rk: &quot;</span></span><br><span class="line">                    + returned.getExchange() + <span class="string">&quot;/&quot;</span> + returned.getRoutingKey());</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2、加载配置类"><a href="#2、加载配置类" class="headerlink" title="2、加载配置类"></a>2、加载配置类</h5><p>resources&#x2F;META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.share.common.rabbit.config.RabbitInitConfigApplicationListener</span><br></pre></td></tr></table></figure>

<h5 id="3、修改配置"><a href="#3、修改配置" class="headerlink" title="3、修改配置"></a>3、修改配置</h5><p>在nacos配置中心，修改share-order-dev.yml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">cknowledge-mode:</span> <span class="string">manual</span> <span class="comment">#默认情况下消息消费者是自动确认消息的，如果要手动确认消息则需要修改确认模式为manual</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 消费者每次从队列获取的消息数量。此属性当不设置时为：轮询分发，设置为1为：公平分发</span></span><br></pre></td></tr></table></figure>

<h5 id="4、MqController"><a href="#4、MqController" class="headerlink" title="4、MqController"></a>4、MqController</h5><p>发送确认消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;发送确认消息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/sendConfirmMessage&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">sendConfirmMessage</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    rabbitService.sendMessage(MqConst.EXCHANGE_TEST, MqConst.ROUTING_CONFIRM, <span class="string">&quot;hello, confirm&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5、TestReceiver"><a href="#5、TestReceiver" class="headerlink" title="5、TestReceiver"></a>5、TestReceiver</h5><p>监听确认消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听确认消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = MqConst.EXCHANGE_TEST, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        value = @Queue(value = MqConst.QUEUE_CONFIRM, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        key = MqConst.ROUTING_CONFIRM</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(String content, Message message, Channel channel)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收确认消息：&#123;&#125;&quot;</span>, content);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// false 确认一个消息，true 批量确认</span></span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-3、消息发送失败，设置重发机制"><a href="#3-3-3、消息发送失败，设置重发机制" class="headerlink" title="3.3.3、消息发送失败，设置重发机制"></a>3.3.3、消息发送失败，设置重发机制</h4><p>实现思路：借助redis来实现重发机制</p>
<p>操作模块：<code>share-common-rabbit</code></p>
<h5 id="1、GmallCorrelationData"><a href="#1、GmallCorrelationData" class="headerlink" title="1、GmallCorrelationData"></a>1、GmallCorrelationData</h5><p>自定义一个实体类来接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.common.rabbit.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiguCorrelationData</span> <span class="keyword">extends</span> <span class="title class_">CorrelationData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息体</span></span><br><span class="line">    <span class="keyword">private</span> Object message;</span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">private</span> String exchange;</span><br><span class="line">    <span class="comment">//路由键</span></span><br><span class="line">    <span class="keyword">private</span> String routingKey;</span><br><span class="line">    <span class="comment">//重试次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//是否延迟消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isDelay</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//延迟时长</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">delayTime</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2、RabbitService"><a href="#2、RabbitService" class="headerlink" title="2、RabbitService"></a>2、RabbitService</h5><p>修改发送方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  发送消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingKey, Object message)</span> &#123;</span><br><span class="line">    <span class="comment">//1.创建自定义相关消息对象-包含业务数据本身，交换器名称，路由键，队列类型，延迟时间,重试次数</span></span><br><span class="line">    <span class="type">GuiguCorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuiguCorrelationData</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> <span class="string">&quot;mq:&quot;</span> + UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    correlationData.setId(uuid);</span><br><span class="line">    correlationData.setMessage(message);</span><br><span class="line">    correlationData.setExchange(exchange);</span><br><span class="line">    correlationData.setRoutingKey(routingKey);</span><br><span class="line">    <span class="comment">//2.将相关消息封装到发送消息方法中</span></span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(exchange, routingKey, message, correlationData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.将相关消息存入Redis  Key：UUID  相关消息对象  10 分钟</span></span><br><span class="line">    redisTemplate.opsForValue().set(uuid, JSON.toJSONString(correlationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3、RabbitInitConfigApplicationListener"><a href="#3、RabbitInitConfigApplicationListener" class="headerlink" title="3、RabbitInitConfigApplicationListener"></a>3、RabbitInitConfigApplicationListener</h5><p>修改RabbitInitConfigApplicationListener类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.common.rabbit.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitInitConfigApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setupCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupCallbacks</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> correlation 相关数据  非消息本身业务数据</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ack             应答结果</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> reason           如果发送消息到交换器失败，错误原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback((correlationData, ack, reason) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">                <span class="comment">//消息到交换器成功</span></span><br><span class="line">                log.info(<span class="string">&quot;消息发送到Exchange成功：&#123;&#125;&quot;</span>, correlationData);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//消息到交换器失败</span></span><br><span class="line">                log.error(<span class="string">&quot;消息发送到Exchange失败：&#123;&#125;&quot;</span>, reason);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//执行消息重发</span></span><br><span class="line">                <span class="built_in">this</span>.retrySendMsg(correlationData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Returned: &quot;</span> + returned.getMessage() + <span class="string">&quot;\nreplyCode: &quot;</span> + returned.getReplyCode()</span><br><span class="line">                    + <span class="string">&quot;\nreplyText: &quot;</span> + returned.getReplyText() + <span class="string">&quot;\nexchange/rk: &quot;</span></span><br><span class="line">                    + returned.getExchange() + <span class="string">&quot;/&quot;</span> + returned.getRoutingKey());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//当路由队列失败 也需要重发</span></span><br><span class="line">            <span class="comment">//1.构建相关数据对象</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> returned.getMessage().getMessageProperties().getHeader(<span class="string">&quot;spring_returned_message_correlation&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">correlationDataStr</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">            <span class="type">GuiguCorrelationData</span> <span class="variable">guiguCorrelationData</span> <span class="operator">=</span> JSON.parseObject(correlationDataStr, GuiguCorrelationData.class);</span><br><span class="line">            <span class="comment">//2.调用消息重发方法</span></span><br><span class="line">            <span class="built_in">this</span>.retrySendMsg(guiguCorrelationData);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息重新发送</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retrySendMsg</span><span class="params">(CorrelationData correlationData)</span> &#123;</span><br><span class="line">        <span class="comment">//获取相关数据</span></span><br><span class="line">        <span class="type">GuiguCorrelationData</span> <span class="variable">gmallCorrelationData</span> <span class="operator">=</span> (GuiguCorrelationData) correlationData;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取redis中存放重试次数</span></span><br><span class="line">        <span class="comment">//先重发，在写会到redis中次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> gmallCorrelationData.getRetryCount();</span><br><span class="line">        <span class="keyword">if</span> (retryCount &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="comment">//超过最大重试次数</span></span><br><span class="line">            log.error(<span class="string">&quot;生产者超过最大重试次数，将失败的消息存入数据库用人工处理；给管理员发送邮件；给管理员发送短信；&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重发消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(), gmallCorrelationData.getRoutingKey(), gmallCorrelationData.getMessage(), gmallCorrelationData);</span><br><span class="line">        <span class="comment">//重发次数+1</span></span><br><span class="line">        retryCount += <span class="number">1</span>;</span><br><span class="line">        gmallCorrelationData.setRetryCount(retryCount);</span><br><span class="line">        redisTemplate.opsForValue().set(gmallCorrelationData.getId(), JSON.toJSONString(gmallCorrelationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        log.info(<span class="string">&quot;进行消息重发！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4、延迟消息"><a href="#3-4、延迟消息" class="headerlink" title="3.4、延迟消息"></a>3.4、延迟消息</h3><p>延迟消息有两种实现方案：</p>
<p>1，基于死信队列</p>
<p>2，集成延迟插件</p>
<h4 id="3-4-1、基于死信实现延迟消息"><a href="#3-4-1、基于死信实现延迟消息" class="headerlink" title="3.4.1、基于死信实现延迟消息"></a>3.4.1、基于死信实现延迟消息</h4><p>使用RabbitMQ来实现延迟消息必须先了解RabbitMQ的两个概念：消息的TTL和死信Exchange，通过这两者的组合来实现延迟队列</p>
<h5 id="1、消息的TTL（Time-To-Live）"><a href="#1、消息的TTL（Time-To-Live）" class="headerlink" title="1、消息的TTL（Time To Live）"></a>1、消息的TTL（Time To Live）</h5><p>消息的TTL就是消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL。对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。</p>
<p>如何设置TTL：</p>
<p>我们创建一个队列queue.temp，在Arguments 中添加x-message-ttl 为5000 （单位是毫秒），那所在压在这个队列的消息在5秒后会消失。</p>
<h5 id="2、死信交换机-Dead-Letter-Exchanges"><a href="#2、死信交换机-Dead-Letter-Exchanges" class="headerlink" title="2、死信交换机  Dead Letter Exchanges"></a>2、死信交换机  Dead Letter Exchanges</h5><p>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列，一个路由可以对应很多队列。</p>
<p>（1） 一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。</p>
<p>（2）<strong>上面的消息的TTL到了，消息过期了。</strong></p>
<p>（3）队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上。</p>
<p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/wps157.jpg" alt="img"> </p>
<p>我们现在可以测试一下延迟队列。</p>
<p>（1）创建死信队列 </p>
<p>（2）创建交换机 </p>
<p>（3）建立交换器与队列之间的绑定 </p>
<p>（4）创建队列</p>
<h5 id="3、代码实现"><a href="#3、代码实现" class="headerlink" title="3、代码实现"></a>3、代码实现</h5><p>操作模块：<code>share-order</code></p>
<h6 id="DeadLetterMqConfig"><a href="#DeadLetterMqConfig" class="headerlink" title="DeadLetterMqConfig"></a>DeadLetterMqConfig</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterMqConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 声明一些变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_dead</span> <span class="operator">=</span> <span class="string">&quot;exchange.dead&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_1</span> <span class="operator">=</span> <span class="string">&quot;routing.dead.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_2</span> <span class="operator">=</span> <span class="string">&quot;routing.dead.2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_1</span> <span class="operator">=</span> <span class="string">&quot;queue.dead.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_2</span> <span class="operator">=</span> <span class="string">&quot;queue.dead.2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">exchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(exchange_dead, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 设置如果队列一 出现问题，则通过参数转到exchange_dead，routing_dead_2 上！</span></span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 参数绑定 此处的key 固定值，不能随意写</span></span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, exchange_dead);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, routing_dead_2);</span><br><span class="line">        <span class="comment">// 设置延迟时间</span></span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 队列名称，是否持久化，是否独享、排外的【true:只可以在本次连接中访问】，是否自动删除，队列的其他属性参数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_dead_1, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 将队列一 通过routing_dead_1 key 绑定到exchange_dead 交换机上</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue1()).to(exchange()).with(routing_dead_1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个队列二就是一个普通队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_dead_2, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置队列二的绑定规则</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 将队列二通过routing_dead_2 key 绑定到exchange_dead交换机上！</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue2()).to(exchange()).with(routing_dead_2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="MqController"><a href="#MqController" class="headerlink" title="MqController"></a>MqController</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送延迟消息：基于死信实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Operation(summary = &quot;发送延迟消息：基于死信实现&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/sendDeadLetterMsg&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">sendDeadLetterMsg</span><span class="params">()</span> &#123;</span><br><span class="line">    rabbitService.sendMessage(DeadLetterMqConfig.exchange_dead, DeadLetterMqConfig.routing_dead_1, <span class="string">&quot;我是延迟消息&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="TestReceiver"><a href="#TestReceiver" class="headerlink" title="TestReceiver"></a>TestReceiver</h6><p>接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听延迟消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;DeadLetterMqConfig.queue_dead_2&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getDeadLetterMsg</span><span class="params">(String msg, Message message, Channel channel)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;死信消费者：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2、基于延迟插件实现延迟消息"><a href="#3-4-2、基于延迟插件实现延迟消息" class="headerlink" title="3.4.2、基于延迟插件实现延迟消息"></a>3.4.2、基于延迟插件实现延迟消息</h4><p>Rabbitmq实现了一个插件x-delay-message来实现延时队列</p>
<h5 id="1、插件安装"><a href="#1、插件安装" class="headerlink" title="1、插件安装"></a>1、插件安装</h5><p>已安装</p>
<h5 id="2、代码实现"><a href="#2、代码实现" class="headerlink" title="2、代码实现"></a>2、代码实现</h5><p>操作模块：<code>share-order</code></p>
<h6 id="DelayedMqConfig"><a href="#DelayedMqConfig" class="headerlink" title="DelayedMqConfig"></a>DelayedMqConfig</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.CustomExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedMqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_delay</span> <span class="operator">=</span> <span class="string">&quot;exchange.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_delay</span> <span class="operator">=</span> <span class="string">&quot;routing.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_delay_1</span> <span class="operator">=</span> <span class="string">&quot;queue.delay.1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQeue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 第一个参数是创建的queue的名字，第二个参数是是否支持持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_delay_1, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(exchange_delay, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayBbinding1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQeue1()).to(delayExchange()).with(routing_delay).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="MqController-1"><a href="#MqController-1" class="headerlink" title="MqController"></a>MqController</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;发送延迟消息：基于延迟插件&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/sendDelayMsg&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">sendDelayMsg</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//调用工具方法发送延迟消息</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">delayTime</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    rabbitService.sendDealyMessage(DelayedMqConfig.exchange_delay, DelayedMqConfig.routing_delay, <span class="string">&quot;我是延迟消息&quot;</span>, delayTime);</span><br><span class="line">    <span class="keyword">return</span> success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="RabbitService"><a href="#RabbitService" class="headerlink" title="RabbitService"></a>RabbitService</h6><p>封装到工具类模块</p>
<p>操作模块：<code>share-common-rabbit</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送延迟消息方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message 消息数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> delayTime 延迟时间，单位为：秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendDealyMessage</span><span class="params">(String exchange, String routingKey, Object message, <span class="type">int</span> delayTime)</span> &#123;</span><br><span class="line">    <span class="comment">//1.创建自定义相关消息对象-包含业务数据本身，交换器名称，路由键，队列类型，延迟时间,重试次数</span></span><br><span class="line">    <span class="type">GuiguCorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuiguCorrelationData</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> <span class="string">&quot;mq:&quot;</span> + UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    correlationData.setId(uuid);</span><br><span class="line">    correlationData.setMessage(message);</span><br><span class="line">    correlationData.setExchange(exchange);</span><br><span class="line">    correlationData.setRoutingKey(routingKey);</span><br><span class="line">    correlationData.setDelay(<span class="literal">true</span>);</span><br><span class="line">    correlationData.setDelayTime(delayTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.将相关消息封装到发送消息方法中</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchange, routingKey, message,message1 -&gt; &#123;</span><br><span class="line">        message1.getMessageProperties().setDelay(delayTime*<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> message1;</span><br><span class="line">    &#125;, correlationData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.将相关消息存入Redis  Key：UUID  相关消息对象  10 分钟</span></span><br><span class="line">    redisTemplate.opsForValue().set(uuid, JSON.toJSONString(correlationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="MQProducerAckConfig"><a href="#MQProducerAckConfig" class="headerlink" title="MQProducerAckConfig"></a>MQProducerAckConfig</h6><p><code>MQProducerAckConfig</code>队列确认增加延迟消息判断</p>
<p>操作模块：<code>share-common-rabbit</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.common.rabbit.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitInitConfigApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupCallbacks</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> correlation 相关数据  非消息本身业务数据</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ack             应答结果</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> reason           如果发送消息到交换器失败，错误原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback((correlationData, ack, reason) -&gt; &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Returned: &quot;</span> + returned.getMessage() + <span class="string">&quot;\nreplyCode: &quot;</span> + returned.getReplyCode()</span><br><span class="line">                    + <span class="string">&quot;\nreplyText: &quot;</span> + returned.getReplyText() + <span class="string">&quot;\nexchange/rk: &quot;</span></span><br><span class="line">                    + returned.getExchange() + <span class="string">&quot;/&quot;</span> + returned.getRoutingKey());</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//todo 方式一:如果不考虑延迟消息重发 直接返回</span></span><br><span class="line">            <span class="keyword">if</span>(guiguCorrelationData.isDelay())&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//2.调用消息重发方法</span></span><br><span class="line">            <span class="built_in">this</span>.retrySendMsg(guiguCorrelationData);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息重新发送</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retrySendMsg</span><span class="params">(CorrelationData correlationData)</span> &#123;</span><br><span class="line">        <span class="comment">//获取相关数据</span></span><br><span class="line">        <span class="type">GuiguCorrelationData</span> <span class="variable">gmallCorrelationData</span> <span class="operator">=</span> (GuiguCorrelationData) correlationData;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取redis中存放重试次数</span></span><br><span class="line">        <span class="comment">//先重发，在写会到redis中次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> gmallCorrelationData.getRetryCount();</span><br><span class="line">        <span class="keyword">if</span> (retryCount &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="comment">//超过最大重试次数</span></span><br><span class="line">            log.error(<span class="string">&quot;生产者超过最大重试次数，将失败的消息存入数据库用人工处理；给管理员发送邮件；给管理员发送短信；&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重发次数+1</span></span><br><span class="line">        retryCount += <span class="number">1</span>;</span><br><span class="line">        gmallCorrelationData.setRetryCount(retryCount);</span><br><span class="line">        redisTemplate.opsForValue().set(gmallCorrelationData.getId(), JSON.toJSONString(gmallCorrelationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        log.info(<span class="string">&quot;进行消息重发！&quot;</span>);</span><br><span class="line">        <span class="comment">//重发消息</span></span><br><span class="line">        <span class="comment">//todo 方式二：如果是延迟消息，依然需要设置消息延迟时间</span></span><br><span class="line">        <span class="keyword">if</span> (gmallCorrelationData.isDelay()) &#123;</span><br><span class="line">            <span class="comment">//延迟消息</span></span><br><span class="line">            rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(), gmallCorrelationData.getRoutingKey(), gmallCorrelationData.getMessage(), message -&gt; &#123;</span><br><span class="line">                message.getMessageProperties().setDelay(gmallCorrelationData.getDelayTime() * <span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;, gmallCorrelationData);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//普通消息</span></span><br><span class="line">            rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(), gmallCorrelationData.getRoutingKey(), gmallCorrelationData.getMessage(), gmallCorrelationData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3、消费者端幂等性处理"><a href="#3、消费者端幂等性处理" class="headerlink" title="3、消费者端幂等性处理"></a>3、消费者端幂等性处理</h5><p>消费结果会发送多次，也被消费多次！</p>
<p>如何保证消息幂等性？</p>
<ol>
<li>使用数据库方式</li>
<li><strong>使用redis setnx 命令解决（推荐）</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听延迟消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;DeadLetterMqConfig.queue_dead_2&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getDeadLetterMsg</span><span class="params">(String msg, Message message, Channel channel)</span> &#123;</span><br><span class="line">    <span class="comment">//接收消息，消费者端判断是否需要做幂等性处理</span></span><br><span class="line">    <span class="comment">//如果业务保证幂等性，基于redis setnx保证</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;mq:&quot;</span> + msg;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;&quot;</span>, <span class="number">200</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">        <span class="comment">//说明该业务数据以及被执行</span></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行业务</span></span><br><span class="line">    <span class="comment">//  TODO </span></span><br><span class="line"></span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-4-3、基于延迟插件实现解锁卡槽"><a href="#3-4-3、基于延迟插件实现解锁卡槽" class="headerlink" title="3.4.3、基于延迟插件实现解锁卡槽"></a>3.4.3、基于延迟插件实现解锁卡槽</h4><h5 id="1、需求说明"><a href="#1、需求说明" class="headerlink" title="1、需求说明"></a>1、需求说明</h5><p>如果我们扫码柜机充电宝，服务器已经成功获取充电宝相关信息，发送Topic消息给柜机了，但是由于柜机原因不能弹出及时充电宝，因此我们要解锁卡槽对应的充电宝</p>
<p>操作模块：<code>share-device</code></p>
<h5 id="2、pom-xml"><a href="#2、pom-xml" class="headerlink" title="2、pom.xml"></a>2、pom.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.share<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>share-common-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="3、发送延迟消息"><a href="#3、发送延迟消息" class="headerlink" title="3、发送延迟消息"></a>3、发送延迟消息</h5><p>DeviceServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> AvailableProwerBankVo <span class="title function_">checkAvailableProwerBank</span><span class="params">(String cabinetNo)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫码后未弹出充电宝等情况，延迟解锁</span></span><br><span class="line">    rabbitService.sendDealyMessage(MqConst.EXCHANGE_DEVICE, MqConst.ROUTING_UNLOCK_SLOT, JSONObject.toJSONString(cabinetSlot), MqConst.CANCEL_UNLOCK_SLOT_DELAY_TIME);</span><br><span class="line">    <span class="keyword">return</span> availableProwerBankVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3、DeviceReceiver"><a href="#3、DeviceReceiver" class="headerlink" title="3、DeviceReceiver"></a>3、DeviceReceiver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.device.receiver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDeviceService deviceService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = MqConst.EXCHANGE_DEVICE, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            value = @Queue(value = MqConst.QUEUE_UNLOCK_SLOT, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            key = MqConst.ROUTING_UNLOCK_SLOT</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlockSlot</span><span class="params">(String content, Message message, Channel channel)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[设备服务]解锁充电宝卡槽消息：&#123;&#125;&quot;</span>, content);</span><br><span class="line">        <span class="type">CabinetSlot</span> <span class="variable">cabinetSlot</span> <span class="operator">=</span> JSONObject.parseObject(content, CabinetSlot.class);</span><br><span class="line">        <span class="comment">//防止重复请求</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;unlock:slot:&quot;</span> + cabinetSlot.getCabinetId() + <span class="string">&quot;:&quot;</span> + cabinetSlot.getSlotNo();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isExist</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, cabinetSlot.getSlotNo(), <span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">        <span class="keyword">if</span> (!isExist) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;重复请求: &#123;&#125;&quot;</span>, content);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            deviceService.unlockSlot(cabinetSlot);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//手动应答</span></span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;设备服务：解锁充电宝卡槽失败：&#123;&#125;&quot;</span>, content, e);</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">            <span class="comment">// 消费异常，重新入队</span></span><br><span class="line">            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4、IDeviceService"><a href="#4、IDeviceService" class="headerlink" title="4、IDeviceService"></a>4、IDeviceService</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void unlockSlot(CabinetSlot cabinetSlot);</span><br></pre></td></tr></table></figure>

<h5 id="5、DeviceServiceI"><a href="#5、DeviceServiceI" class="headerlink" title="5、DeviceServiceI"></a>5、DeviceServiceI</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlockSlot</span><span class="params">(CabinetSlot cs)</span> &#123;</span><br><span class="line">    <span class="type">CabinetSlot</span> <span class="variable">cabinetSlot</span> <span class="operator">=</span> cabinetSlotService.getById(cs.getId());</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;2&quot;</span>.equals(cabinetSlot.getStatus())) &#123;</span><br><span class="line">        <span class="comment">//状态（1：占用 0：空闲 2：锁定）</span></span><br><span class="line">        cabinetSlot.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        cabinetSlot.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        cabinetSlotService.updateById(cabinetSlot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、创建订单"><a href="#4、创建订单" class="headerlink" title="4、创建订单"></a>4、创建订单</h2><p>前面完成了充电宝弹出相关业务，创建订单是通过mq消息，因此完成该功能</p>
<h3 id="4-1、发送消息"><a href="#4-1、发送消息" class="headerlink" title="4.1、发送消息"></a>4.1、发送消息</h3><h4 id="4-1-1、PowerBankUnlockHandler"><a href="#4-1-1、PowerBankUnlockHandler" class="headerlink" title="4.1.1、PowerBankUnlockHandler"></a>4.1.1、PowerBankUnlockHandler</h4><p>完善发送创建订单消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(JSONObject message)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;handleMessage: &#123;&#125;&quot;</span>, message.toJSONString());</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建订单对象</span></span><br><span class="line">    <span class="type">SubmitOrderVo</span> <span class="variable">submitOrderVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubmitOrderVo</span>();</span><br><span class="line">    submitOrderVo.setMessageNo(messageNo);</span><br><span class="line">    submitOrderVo.setUserId(userId);</span><br><span class="line">    submitOrderVo.setPowerBankNo(powerBankNo);</span><br><span class="line">    submitOrderVo.setStartStationId(station.getId());</span><br><span class="line">    submitOrderVo.setStartStationName(station.getName());</span><br><span class="line">    submitOrderVo.setStartCabinetNo(cabinetNo);</span><br><span class="line">    submitOrderVo.setFeeRuleId(station.getFeeRuleId());</span><br><span class="line">    log.info(<span class="string">&quot;构建订单对象: &#123;&#125;&quot;</span>, JSONObject.toJSONString(submitOrderVo));</span><br><span class="line">    <span class="comment">//发送信息</span></span><br><span class="line">    rabbitService.sendMessage(MqConst.EXCHANGE_ORDER, MqConst.ROUTING_SUBMIT_ORDER, JSONObject.toJSONString(submitOrderVo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2、SubmitOrderVo"><a href="#4-1-2、SubmitOrderVo" class="headerlink" title="4.1.2、SubmitOrderVo"></a>4.1.2、SubmitOrderVo</h4><p>该实体放到<code>share-api-order</code>模块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.order.api.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.v3.oas.annotations.media.Schema;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubmitOrderVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;消息编号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String messageNo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;用户Id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long UserId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//送货地址id</span></span><br><span class="line">    <span class="meta">@Schema(description = &quot;充电宝编号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String powerBankNo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 借用站点id */</span></span><br><span class="line">    <span class="meta">@Schema(description = &quot;借用站点id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long startStationId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 借用地点名称 */</span></span><br><span class="line">    <span class="meta">@Schema(description = &quot;借用地点名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String startStationName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 借用柜机编号 */</span></span><br><span class="line">    <span class="meta">@Schema(description = &quot;借用柜机编号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String startCabinetNo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;费用规则id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long feeRuleId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2、接收消息"><a href="#4-2、接收消息" class="headerlink" title="4.2、接收消息"></a>4.2、接收消息</h3><h4 id="4-2-1、OrderReceiver"><a href="#4-2-1、OrderReceiver" class="headerlink" title="4.2.1、OrderReceiver"></a>4.2.1、OrderReceiver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.share.order.receiver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IOrderInfoService orderInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = MqConst.EXCHANGE_ORDER, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            value = @Queue(value = MqConst.QUEUE_SUBMIT_ORDER, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            key = MqConst.ROUTING_SUBMIT_ORDER</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submitOrder</span><span class="params">(String content, Message message, Channel channel)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[订单服务]租借充电宝消息：&#123;&#125;&quot;</span>, content);</span><br><span class="line">        <span class="type">SubmitOrderVo</span> <span class="variable">orderForm</span> <span class="operator">=</span> JSONObject.parseObject(content, SubmitOrderVo.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageNo</span> <span class="operator">=</span> orderForm.getMessageNo();</span><br><span class="line">        <span class="comment">//防止重复请求</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;order:submit:&quot;</span> + messageNo;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isExist</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, messageNo, <span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">        <span class="keyword">if</span> (!isExist) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;重复请求: &#123;&#125;&quot;</span>, content);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderInfoService.saveOrder(orderForm);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//手动应答</span></span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;订单服务：订单归还失败，订单编号：&#123;&#125;&quot;</span>, messageNo, e);</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">            <span class="comment">// 消费异常，重新入队</span></span><br><span class="line">            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2、IOrderInfoService"><a href="#4-2-2、IOrderInfoService" class="headerlink" title="4.2.2、IOrderInfoService"></a>4.2.2、IOrderInfoService</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long saveOrder(SubmitOrderVo orderForm);</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2、OrderInfoServiceI"><a href="#4-2-2、OrderInfoServiceI" class="headerlink" title="4.2.2、OrderInfoServiceI"></a>4.2.2、OrderInfoServiceI</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RemoteFeeRuleService remoteFeeRuleService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveOrder</span><span class="params">(SubmitOrderVo orderForm)</span> &#123;</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">    orderInfo.setUserId(orderForm.getUserId());</span><br><span class="line">    orderInfo.setOrderNo(RandomUtil.randomString(<span class="number">8</span>));</span><br><span class="line">    orderInfo.setPowerBankNo(orderForm.getPowerBankNo());</span><br><span class="line">    orderInfo.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    orderInfo.setStartStationId(orderForm.getStartStationId());</span><br><span class="line">    orderInfo.setStartStationName(orderForm.getStartStationName());</span><br><span class="line">    orderInfo.setStartCabinetNo(orderForm.getStartCabinetNo());</span><br><span class="line">    <span class="comment">// 费用规则</span></span><br><span class="line">    <span class="type">FeeRule</span> <span class="variable">feeRule</span> <span class="operator">=</span> remoteFeeRuleService.getFeeRule(orderForm.getFeeRuleId(), SecurityConstants.INNER).getData();</span><br><span class="line">    orderInfo.setFeeRuleId(orderForm.getFeeRuleId());</span><br><span class="line">    orderInfo.setFeeRule(feeRule.getDescription());</span><br><span class="line">    orderInfo.setStatus(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">    orderInfo.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    orderInfo.setCreateBy(SecurityUtils.getUsername());</span><br><span class="line">    <span class="comment">//用户昵称</span></span><br><span class="line">    <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span>  remoteUserInfoService.getUserInfo(orderInfo.getUserId(), SecurityConstants.INNER).getData();</span><br><span class="line">    orderInfo.setNickname(userInfo.getNickname());</span><br><span class="line"></span><br><span class="line">    orderInfoMapper.insert(orderInfo);</span><br><span class="line">    <span class="keyword">return</span> orderInfo.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">civets</div><div class="post-copyright__author_desc">生活明朗，万物可爱</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/02/27/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/11_RabbitMQ/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/02/27/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/11_RabbitMQ/')">Civets</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2025/02/27/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/11_RabbitMQ/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=http://example.com/2025/02/27/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/11_RabbitMQ/&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Civets</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/02/27/Project/Bilibili/Bilibili/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2025/02/28/Project/%E5%B0%8F%E8%B0%B7%E5%85%85%E7%94%B5%E5%AE%9D/13_%E5%85%85%E7%94%B5%E5%AE%9D%E5%BD%92%E8%BF%98/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://java-mybatis-tlias.oss-cn-beijing.aliyuncs.com/blog/%E7%99%BD%E7%8C%AB.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/cbd1fc6ade730.gif" alt="status"/></div></div><div class="author-info__description">狸猫玖玖的小窝.zzz</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">civets</h1><div class="author-info__desc">生活明朗，万物可爱</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/xiaojiu1233" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/572075999" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">1、消息队列解决什么问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E5%BC%82%E6%AD%A5"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1、异步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E8%A7%A3%E8%80%A6"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2、解耦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81%E5%B9%B6%E8%A1%8C"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3、并行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81%E6%8E%92%E9%98%9F"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4、排队</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81MQ%E6%95%B4%E5%90%88"><span class="toc-number">1.2.</span> <span class="toc-text">2、MQ整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1、使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E8%AE%BF%E9%97%AERabbitMQ"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2、访问RabbitMQ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81RabbitMQ%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">3、RabbitMQ模块搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E6%90%AD%E5%BB%BAshare-common-rabbit%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1、搭建share-common-rabbit模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1%E3%80%81%E6%96%B0%E5%BB%BA%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">3.1.1、新建模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2%E3%80%81pom-xml"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">3.1.2、pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3%E3%80%81RabbitService"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">3.1.3、RabbitService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4%E3%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">3.1.4、加载配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-5%E3%80%81MqConst"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">3.1.5、MqConst</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81-RabbitMQ%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2、  RabbitMQ测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1%E3%80%81%E9%85%8D%E7%BD%AERabbitMQ"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">3.2.1、配置RabbitMQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2%E3%80%81%E5%BC%95%E5%85%A5share-common-rabbit%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">3.2.2、引入share-common-rabbit模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3%E3%80%81MqController"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3.2.3、MqController</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4%E3%80%81TestReceiver"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">3.2.4、TestReceiver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5%E3%80%81knife4j%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">3.2.5、knife4j测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3、消息可靠性配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1%E3%80%81%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">3.3.1、介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%A1%AE%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">3.3.2、消息发送确认配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E5%B0%81%E8%A3%85%E5%8F%91%E9%80%81%E7%AB%AF%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.3.3.2.1.</span> <span class="toc-text">1、封装发送端消息确认配置类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.3.3.2.2.</span> <span class="toc-text">2、加载配置类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.2.3.</span> <span class="toc-text">3、修改配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81MqController"><span class="toc-number">1.3.3.2.4.</span> <span class="toc-text">4、MqController</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%E3%80%81TestReceiver"><span class="toc-number">1.3.3.2.5.</span> <span class="toc-text">5、TestReceiver</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E5%A4%B1%E8%B4%A5%EF%BC%8C%E8%AE%BE%E7%BD%AE%E9%87%8D%E5%8F%91%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">3.3.3、消息发送失败，设置重发机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81GmallCorrelationData"><span class="toc-number">1.3.3.3.1.</span> <span class="toc-text">1、GmallCorrelationData</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81RabbitService"><span class="toc-number">1.3.3.3.2.</span> <span class="toc-text">2、RabbitService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81RabbitInitConfigApplicationListener"><span class="toc-number">1.3.3.3.3.</span> <span class="toc-text">3、RabbitInitConfigApplicationListener</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%E3%80%81%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4、延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1%E3%80%81%E5%9F%BA%E4%BA%8E%E6%AD%BB%E4%BF%A1%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">3.4.1、基于死信实现延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84TTL%EF%BC%88Time-To-Live%EF%BC%89"><span class="toc-number">1.3.4.1.1.</span> <span class="toc-text">1、消息的TTL（Time To Live）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA-Dead-Letter-Exchanges"><span class="toc-number">1.3.4.1.2.</span> <span class="toc-text">2、死信交换机  Dead Letter Exchanges</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.4.1.3.</span> <span class="toc-text">3、代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#DeadLetterMqConfig"><span class="toc-number">1.3.4.1.3.1.</span> <span class="toc-text">DeadLetterMqConfig</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#MqController"><span class="toc-number">1.3.4.1.3.2.</span> <span class="toc-text">MqController</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#TestReceiver"><span class="toc-number">1.3.4.1.3.3.</span> <span class="toc-text">TestReceiver</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2%E3%80%81%E5%9F%BA%E4%BA%8E%E5%BB%B6%E8%BF%9F%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">3.4.2、基于延迟插件实现延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.4.2.1.</span> <span class="toc-text">1、插件安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.4.2.2.</span> <span class="toc-text">2、代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#DelayedMqConfig"><span class="toc-number">1.3.4.2.2.1.</span> <span class="toc-text">DelayedMqConfig</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#MqController-1"><span class="toc-number">1.3.4.2.2.2.</span> <span class="toc-text">MqController</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#RabbitService"><span class="toc-number">1.3.4.2.2.3.</span> <span class="toc-text">RabbitService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#MQProducerAckConfig"><span class="toc-number">1.3.4.2.2.4.</span> <span class="toc-text">MQProducerAckConfig</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E7%AB%AF%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86"><span class="toc-number">1.3.4.2.3.</span> <span class="toc-text">3、消费者端幂等性处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3%E3%80%81%E5%9F%BA%E4%BA%8E%E5%BB%B6%E8%BF%9F%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E8%A7%A3%E9%94%81%E5%8D%A1%E6%A7%BD"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">3.4.3、基于延迟插件实现解锁卡槽</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.4.3.1.</span> <span class="toc-text">1、需求说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81pom-xml"><span class="toc-number">1.3.4.3.2.</span> <span class="toc-text">2、pom.xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E5%8F%91%E9%80%81%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.3.4.3.3.</span> <span class="toc-text">3、发送延迟消息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81DeviceReceiver"><span class="toc-number">1.3.4.3.4.</span> <span class="toc-text">3、DeviceReceiver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81IDeviceService"><span class="toc-number">1.3.4.3.5.</span> <span class="toc-text">4、IDeviceService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%E3%80%81DeviceServiceI"><span class="toc-number">1.3.4.3.6.</span> <span class="toc-text">5、DeviceServiceI</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95"><span class="toc-number">1.4.</span> <span class="toc-text">4、创建订单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E3%80%81%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1、发送消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1%E3%80%81PowerBankUnlockHandler"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">4.1.1、PowerBankUnlockHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2%E3%80%81SubmitOrderVo"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">4.1.2、SubmitOrderVo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E3%80%81%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2、接收消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1%E3%80%81OrderReceiver"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">4.2.1、OrderReceiver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2%E3%80%81IOrderInfoService"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">4.2.2、IOrderInfoService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2%E3%80%81OrderInfoServiceI"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">4.2.2、OrderInfoServiceI</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/02/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" title="无题">无题</a><time datetime="2025-04-02T00:35:45.693Z" title="发表于 2025-04-02 08:35:45">2025-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/01/Docker/" title="无题">无题</a><time datetime="2025-04-01T03:40:15.283Z" title="发表于 2025-04-01 11:40:15">2025-04-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/31/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="无题">无题</a><time datetime="2025-03-31T01:03:23.952Z" title="发表于 2025-03-31 09:03:23">2025-03-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/29/ELK/" title="无题">无题</a><time datetime="2025-03-29T14:21:46.266Z" title="发表于 2025-03-29 22:21:46">2025-03-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/29/%E8%BF%99%E9%87%8C%E6%98%AF%E4%B8%80%E4%BB%BD%E5%AE%8C%E6%95%B4%E7%9A%84%20Java%20%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF%EF%BC%8C%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E9%AB%98%E7%BA%A7%EF%BC%8C%E6%B6%B5%E7%9B%96%20Java%20%E6%A0%B8%E5%BF%83%E3%80%81Web%20%E5%BC%80%E5%8F%91%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E7%AD%89%EF%BC%8C%E9%80%82%E5%90%88%E6%83%B3%E8%A6%81%E6%B7%B1%E5%85%A5%E6%8E%8C%E6%8F%A1%20Java%20%E5%B9%B6%E5%BA%94%E7%94%A8%E5%88%B0%20%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%A1%B9%E7%9B%AE%20%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%80%85%E3%80%82/" title="无题">无题</a><time datetime="2025-03-29T08:13:24.006Z" title="发表于 2025-03-29 16:13:24">2025-03-29</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="civets" target="_blank">civets</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://fn-civets.s.odn.cc" title="CivetsNas"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="CivetsNas"/><span class="back-menu-item-text">CivetsNas</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("22/03/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 civets 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>